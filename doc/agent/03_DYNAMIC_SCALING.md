# Agentの動的増減

## 概要

タスク量や負荷に応じてWORKERの数を動的に増減させる。
LEADERが判断し、必要に応じてWORKERを生成・終了する。

## 増減の対象

| Agent種別 | 動的増減 | 理由 |
|----------|---------|------|
| DIRECTOR | なし | Phase毎に1体固定 |
| LEADER | なし | 機能単位で1体固定 |
| WORKER | あり | タスク量に応じて増減 |

## WORKERの生成条件

### 生成トリガー

| 条件 | 説明 |
|------|------|
| タスク割当時 | LEADERがタスクを受け取ったら、WORKERを生成 |
| 並列実行可能時 | 依存関係のないタスクが複数ある場合 |

### 生成上限（DB管理）

WORKER数の上限はDBで管理し、WebUIから確認・変更できる。

**scaling_configテーブル:**

| key | 初期値 | 説明 |
|-----|-------|------|
| max_workers_per_leader | 5 | 1 LEADERあたりの最大WORKER数 |
| max_workers_per_phase | 10 | 1 Phaseあたりの最大WORKER数 |
| max_workers_total | 20 | システム全体の最大WORKER数 |
| queue_max_size | 100 | 待機キューの最大サイズ |
| queue_timeout_seconds | 300 | キュー待ちタイムアウト |

### WebUI設定画面

| 設定項目 | DB key | 説明 |
|---------|--------|------|
| LEADERあたりWORKER上限 | max_workers_per_leader | スライダー（1〜10） |
| Phaseあたり上限 | max_workers_per_phase | スライダー（1〜20） |
| 全体上限 | max_workers_total | スライダー（1〜50） |
| キューサイズ | queue_max_size | 数値入力 |
| キュータイムアウト | queue_timeout_seconds | 数値入力（秒） |

## WORKERの終了条件

| 条件 | 詳細 | アクション |
|------|------|-----------|
| タスク完了（承認不要） | テスト実行など、自動検証で完了判定できるタスク | 即座に終了 |
| タスク完了（承認待ち） | Human承認が必要なタスク | 成果物を提出して待機、LEADERが承認提出後に終了 |
| タスク失敗（リトライ上限） | 最大3回のリトライ後も失敗 | 終了、LEADERにエスカレーション |
| タイムアウト | 設定時間を超過 | 終了、LEADERにエスカレーション |
| リソース不足 | システムリソースが逼迫 | 優先度の低いWORKERを終了 |

## スケーリング戦略

### 戦略1: タスクベース（デフォルト）

- 1タスク = 1 WORKER
- 最大数に達したらキュー待ち
- キューからFIFOで取り出し

### 戦略2: 負荷ベース

- CPU/メモリ使用率に応じてWORKERを増減
- 使用率 < 50%: WORKER追加可能
- 使用率 > 80%: WORKER追加停止
- 使用率 > 90%: WORKER削減

## 監視メトリクス

| メトリクス | 説明 |
|-----------|------|
| active_workers | 現在稼働中のWORKER数 |
| queued_tasks | キュー待ちタスク数 |
| avg_task_duration | 平均タスク完了時間 |
| worker_utilization | WORKER稼働率 |
| scale_up_events | スケールアップ回数 |
| scale_down_events | スケールダウン回数 |

## 実装時の注意

### 1. リソースリーク防止

WORKERが正常終了しない場合のクリーンアップ処理が必要。
一定時間応答なしのWORKERを検出して強制終了する。

### 2. デッドロック防止

全WORKERが依存タスク待ちになると処理が停止する。

**防止策:**
- 循環依存を検出（トポロジカルソートで確認）
- 独立タスクが最低1つあることを確認
- 独立タスク用に常に1スロットを確保

### 3. 優先度管理

重要タスクが後回しにならないようキュー管理。
