# ログシステムの改良

## 概要

ログをAgent単位、グループ単位、Task単位で閲覧できるようにする。
従来のファイル形式のログに加え、構造化されたログを提供する。

## ログの階層

| パス | 説明 |
|------|------|
| logs/directors/ | DIRECTOR レベル（phase1_director.log等） |
| logs/leaders/ | LEADER レベル（concept_leader.log等） |
| logs/workers/ | WORKER レベル（worker_task_001.log等） |
| logs/tasks/ | タスク単位（横断的） |
| logs/groups/ | グループ単位（集約） |
| logs/combined/ | 全体ログ |

## ログエントリ形式

### 構造化ログ（JSONL）

| フィールド | 説明 |
|-----------|------|
| timestamp | タイムスタンプ |
| level | ログレベル（DEBUG/INFO/WARN/ERROR/FATAL） |
| session_id | セッションID |
| project_id | プロジェクトID |
| agent | エージェント情報（role, type, id） |
| task | タスク情報（id, name, phase） |
| group | グループ |
| message | ログメッセージ |
| details | 詳細情報 |
| metrics | メトリクス（tokens_used, duration_ms, cost_usd） |

### 人間可読ログ（テキスト）

フォーマット例:
`2024-01-15 14:30:00 [INFO] [WORKER:code:worker_task_p2_code_003] [task_p2_code_003] ジャンプ機能の実装を完了`

## ログレベル

| レベル | 用途 | 例 |
|--------|------|-----|
| DEBUG | 詳細なデバッグ情報 | 変数値、内部状態 |
| INFO | 通常の動作情報 | タスク開始/完了 |
| WARN | 警告（動作は継続） | リトライ発生、性能低下 |
| ERROR | エラー（タスク失敗） | 実行エラー、検証失敗 |
| FATAL | 致命的エラー（停止） | システムエラー |

## ログ検索・閲覧

### WebUI ログビューア機能

| 機能 | 説明 |
|------|------|
| フィルタ | Agent種別、グループ、タスクID、時間範囲、レベル |
| 検索 | テキスト検索 |
| リアルタイム | WebSocket経由でリアルタイム更新 |
| エクスポート | JSON/CSV形式でダウンロード |

### APIエンドポイント

| メソッド | パス | 説明 |
|---------|------|------|
| GET | /logs | ログ検索 |
| GET | /logs/stream | リアルタイムストリーム（WebSocket） |
| GET | /logs/export | エクスポート |
| GET | /logs/stats | 統計情報 |

## ログローテーション

### 設定項目

| 設定 | 説明 |
|------|------|
| max_size_mb | 最大ファイルサイズ |
| max_files | 保持するファイル数 |
| compress | 圧縮するかどうか |
| retention_days | 保持日数 |

## UIログタブの出力方針

### 概要

WebUIのログタブに表示されるログは、ユーザーがエージェントの動作を監視するための重要な情報源である。
適切なログレベルと出力タイミングを設定することで、システムの透明性を高める。

### ログの種類

| 種類 | テーブル | 用途 |
|------|----------|------|
| AgentLog | agent_logs | 個別エージェントの実行ログ |
| SystemLog | system_logs | プロジェクト全体のシステムログ |

### ログレベル別の出力基準

#### DEBUG
開発時のトレース情報。本番環境ではフィルタで非表示。
- ツール呼び出しの引数・戻り値
- 内部状態の変化
- ループ処理の詳細

#### INFO
運用時の正常フロー確認。デフォルトで表示。
- エージェント開始・完了
- フェーズ移行
- チェックポイント作成
- アセット生成成功
- ファイル保存完了

#### WARN
異常だが継続可能な状態。注意喚起として表示。
- リトライ発生（API応答遅延など）
- トークン使用量が閾値（80%）超過
- 検証で軽微な問題検出
- 処理時間が想定より長い
- パラメータ数が多い（バランス調整など）

#### ERROR
処理失敗。ユーザーの注意が必要。
- API呼び出し失敗
- 検証失敗（型エラー、整合性エラー）
- ファイル保存失敗
- テスト失敗
- タイムアウト

### 出力タイミングの指針

#### エージェント実行中
```
[INFO]  10% - 初期化完了
[INFO]  30% - LLM呼び出し開始
[WARN]  50% - トークン使用量80%超過
[INFO]  70% - 検証完了
[ERROR] 80% - コンパイルエラー検出
[INFO]  85% - エラー修正完了
[INFO]  90% - ファイル保存完了
```

#### フェーズ移行時
```
[INFO] フェーズ1完了、フェーズ2を開始します
[INFO] 依存関係チェック完了、次のエージェントを起動
```

#### 異常系
```
[WARN]  API応答遅延 - リトライ中 (1/3)
[ERROR] 検証失敗 - 型不一致エラー (src/main.ts:15)
[INFO]  問題修正完了、処理を継続
```

### 設定ファイル

マイルストーン設定: `backend/config/messages.yaml`

```yaml
milestones:
  agent_type:
    - progress: 10
      level: info
      message: 初期化完了
    - progress: 50
      level: warn
      message: リソース使用量注意
    - progress: 80
      level: error
      message: 検証エラー検出
```

### 実装箇所

| ファイル | 関数 | 用途 |
|----------|------|------|
| services/agent_event_emitter.py | emit_log() | エージェントログ出力 |
| services/base_service.py | _add_system_log() | システムログ出力 |
| services/simulation/agent_simulator.py | _check_milestone_logs() | マイルストーンログ |

### ベストプラクティス

1. **コンテキスト情報を含める**
   - agent_id, project_id を必ず含める
   - 具体的な数値（進捗%、トークン数）を記載

2. **ユーザー視点のメッセージ**
   - 技術的な内部用語を避ける
   - 何が起きているかを明確に伝える

3. **エラー時は解決策も示す**
   - エラーの内容だけでなく、修正中・修正完了も出力
   - ユーザーが次のアクションを判断できるように

4. **過剰なログを避ける**
   - 1秒ごとの進捗更新は不要
   - 意味のある節目（マイルストーン）でのみ出力
