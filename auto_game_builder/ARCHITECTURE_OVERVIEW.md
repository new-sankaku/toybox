# ゲーム自動生成 全体アーキテクチャ

## 1. 基本思想

```
┌────────────────────────────────────────────────────────────────────┐
│                                                                    │
│   「AIが生成し続け、人間がレビュー・フィードバックで品質を上げる」    │
│                                                                    │
│   - AIは休まず生成を続ける                                          │
│   - 人間はいつでも介入できる                                        │
│   - フォルダベースで誰でも簡単にフィードバック                        │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## 2. 全体フロー図

```
                              ┌─────────────────┐
                              │    人間 (You)    │
                              └────────┬────────┘
                                       │
            ┌──────────────────────────┼──────────────────────────┐
            │                          │                          │
            ▼                          ▼                          ▼
     ┌────────────┐            ┌────────────┐            ┌────────────┐
     │  企画入力   │            │  レビュー   │            │ フィードバック│
     │            │            │  & 承認    │            │  & 修正依頼 │
     └─────┬──────┘            └─────┬──────┘            └──────┬─────┘
           │                         │                          │
           ▼                         ▼                          ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│                          ゲーム生成システム                                │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        オーケストレーター                            │ │
│  │                   (全体制御・状態管理・差し替え)                      │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│         │                    │                    │                     │
│         ▼                    ▼                    ▼                     │
│  ┌────────────┐      ┌────────────┐      ┌────────────┐               │
│  │  テキスト   │      │   画像     │      │   音声     │               │
│  │  生成      │      │   生成     │      │   生成     │               │
│  │ (Ollama)   │      │ (ComfyUI)  │      │(VOICEVOX等)│               │
│  └────────────┘      └────────────┘      └────────────┘               │
│         │                    │                    │                     │
│         └────────────────────┴────────────────────┘                     │
│                              │                                          │
│                              ▼                                          │
│                    ┌──────────────────┐                                │
│                    │   アセット格納    │                                │
│                    │   & 状態管理     │                                │
│                    └──────────────────┘                                │
│                              │                                          │
└──────────────────────────────┼──────────────────────────────────────────┘
                               │
                               ▼
                    ┌──────────────────┐
                    │   ゲーム出力      │
                    │  (実行可能)       │
                    └──────────────────┘
```

---

## 3. 人間との協働インターフェース

### 3.1 フォルダベースのフィードバックシステム

```
project/
│
├── _inbox/                    ← 人間からの入力を受け付ける
│   ├── requests/              ← 新規リクエスト・追加要望
│   │   └── "キャラAの髪を青くして.txt"
│   │
│   ├── bugs/                  ← バグ報告
│   │   └── "戦闘BGMが途切れる.txt"
│   │
│   ├── feedback/              ← 改善フィードバック
│   │   └── "hero_normal.png.txt"  (対象ファイル名.txt)
│   │
│   └── approve/               ← 承認するアセットをここに移動
│       └── hero_normal.png    (コピーまたは移動)
│
├── _outbox/                   ← システムからの出力・通知
│   ├── pending_review/        ← レビュー待ちアセット
│   │   ├── hero_normal.png
│   │   ├── hero_happy.png
│   │   └── ...
│   │
│   ├── needs_human/           ← 人間の判断が必要
│   │   └── "キャラデザイン方向性の確認.txt"
│   │
│   └── reports/               ← 進捗レポート
│       └── daily_report.md
│
├── assets/                    ← 生成済みアセット
│   ├── approved/              ← 承認済み（本番使用）
│   ├── generated/             ← AI生成済み（レビュー待ち）
│   └── mock/                  ← モック（プレースホルダー）
│
└── game/                      ← ゲーム本体
```

### 3.2 フィードバックの書き方

```
■ 改善フィードバック例 (_inbox/feedback/hero_normal.png.txt)
─────────────────────────────────────────
対象: hero_normal.png
種類: 修正依頼

問題点:
- 目が大きすぎる
- 剣のデザインがイメージと違う

希望:
- 目をもう少し小さく、クールな印象に
- 剣は西洋風のロングソードに

参考画像: references/sword_example.jpg
─────────────────────────────────────────

■ バグ報告例 (_inbox/bugs/battle_bgm_cut.txt)
─────────────────────────────────────────
現象: 戦闘BGMが30秒で途切れる
再現: 戦闘開始後、30秒経過すると無音になる
期待: ループ再生されるべき
対象ファイル: assets/audio/bgm_battle.wav
─────────────────────────────────────────

■ 新規リクエスト例 (_inbox/requests/new_character.txt)
─────────────────────────────────────────
リクエスト: 新キャラクター追加

名前: マリア
役割: 回復役の僧侶
外見: 白いローブ、銀髪、優しい表情
必要アセット:
- 立ち絵 (通常、笑顔、悲しみ)
- 戦闘アイコン
- ボイス
─────────────────────────────────────────
```

---

## 4. ワークフロー詳細

### 4.1 生成 → レビュー → 承認 フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐           │
│   │ リクエスト│    │   生成   │    │ レビュー │    │   承認   │           │
│   │ 受付    │ →  │  (AI)   │ →  │  待ち   │ →  │  済み   │           │
│   └─────────┘    └─────────┘    └─────────┘    └─────────┘           │
│        ↑                              │              │                 │
│        │                              │              │                 │
│        │         ┌─────────┐          │              │                 │
│        └─────────│ 再生成   │←─────────┤              │                 │
│                  │ (修正)   │   NG     │              │                 │
│                  └─────────┘          │              ▼                 │
│                                       │       ┌─────────┐             │
│                                       │       │ ゲームに │             │
│                                       └──────►│ 反映    │             │
│                                         OK    └─────────┘             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 状態遷移

```
┌──────────────────────────────────────────────────────────────────────┐
│                        アセットの状態遷移                             │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│    [NONE]                                                            │
│       │                                                              │
│       │ リクエスト登録                                                │
│       ▼                                                              │
│    [QUEUED] ─────────────────────────────────────────────┐          │
│       │                                                   │          │
│       │ 生成開始                                          │ キャンセル │
│       ▼                                                   │          │
│    [GENERATING]                                           │          │
│       │                                                   │          │
│       ├─────────────┐                                     │          │
│       │ 成功        │ 失敗                                │          │
│       ▼             ▼                                     │          │
│    [GENERATED]   [FAILED] ────────────────────────────────┤          │
│       │             │                                     │          │
│       │             │ 再試行                              │          │
│       │             └──────────► [QUEUED]                 │          │
│       │                                                   │          │
│       │ レビュー待ち                                       │          │
│       ▼                                                   │          │
│    [PENDING_REVIEW] ◄────────────────────────────┐        │          │
│       │                                          │        │          │
│       ├─────────────┬─────────────┐              │        │          │
│       │ 承認        │ 却下        │ 修正依頼     │        │          │
│       ▼             ▼             │              │        │          │
│    [APPROVED]   [REJECTED]        └──────────────┘        │          │
│       │             │                                     │          │
│       │             │                                     │          │
│       ▼             ▼                                     ▼          │
│    [IN_USE]     [ARCHIVED]                           [CANCELLED]    │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 5. 処理パイプライン

### 5.1 メインパイプライン

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            メインパイプライン                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐             │
│  │         │     │         │     │         │     │         │             │
│  │ 企画    │────►│ 設計    │────►│ 生成    │────►│ 統合    │             │
│  │         │     │         │     │         │     │         │             │
│  └─────────┘     └─────────┘     └─────────┘     └─────────┘             │
│       │               │               │               │                   │
│       ▼               ▼               ▼               ▼                   │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐             │
│  │ゲーム   │     │アセット │     │各ワーカー│     │ゲーム   │             │
│  │コンセプト│     │リスト   │     │が並列    │     │ビルド   │             │
│  │定義     │     │生成     │     │生成     │     │        │             │
│  └─────────┘     └─────────┘     └─────────┘     └─────────┘             │
│                                       │                                    │
│                         ┌─────────────┼─────────────┐                     │
│                         ▼             ▼             ▼                     │
│                    ┌─────────┐  ┌─────────┐  ┌─────────┐                │
│                    │ 画像    │  │ テキスト │  │ 音声    │                │
│                    │ パイプ  │  │ パイプ   │  │ パイプ  │                │
│                    └─────────┘  └─────────┘  └─────────┘                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 画像生成パイプライン

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           画像生成パイプライン                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐             │
│  │         │     │         │     │         │     │         │             │
│  │ 設定    │────►│ プロンプト│────►│ 生成    │────►│ 後処理  │             │
│  │ 読込    │     │ 構築    │     │ (ComfyUI)│     │         │             │
│  └─────────┘     └─────────┘     └─────────┘     └─────────┘             │
│                                       │               │                   │
│                                       ▼               ▼                   │
│                                  ┌─────────┐    ┌─────────┐             │
│                                  │ 品質    │    │ リサイズ │             │
│                                  │ チェック │    │ 形式変換 │             │
│                                  └─────────┘    └─────────┘             │
│                                       │                                    │
│                        ┌──────────────┼──────────────┐                    │
│                        ▼              ▼              ▼                    │
│                   [OK: 保存]    [NG: 再生成]   [要確認: 人間へ]            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 音声生成パイプライン

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           音声生成パイプライン                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐   │
│  │                        BGM パイプライン                             │   │
│  │  [ジャンル/ムード指定] → [Suno/MusicGen] → [ループ処理] → [出力]    │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐   │
│  │                        SE パイプライン                              │   │
│  │  [効果音タイプ指定] → [AudioLDM] → [ノーマライズ] → [出力]          │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐   │
│  │                       ボイス パイプライン                           │   │
│  │  [テキスト] → [話者選択] → [VOICEVOX] → [音量調整] → [出力]        │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 テキスト生成パイプライン

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          テキスト生成パイプライン                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐   │
│  │                     シナリオ パイプライン                           │   │
│  │  [プロット] → [章構成] → [シーン展開] → [ダイアログ] → [校正]       │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐   │
│  │                    ゲームデータ パイプライン                         │   │
│  │  [設計指針] → [パラメータ生成] → [バランス検証] → [JSON出力]        │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐   │
│  │                      コード パイプライン                            │   │
│  │  [要件] → [設計] → [実装] → [テスト生成] → [検証]                  │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 並列処理アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             並列処理構成                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         ┌─────────────────┐                                │
│                         │  オーケストレーター │                                │
│                         │  (タスク配分)     │                                │
│                         └────────┬────────┘                                │
│                                  │                                          │
│            ┌─────────────────────┼─────────────────────┐                   │
│            │                     │                     │                   │
│            ▼                     ▼                     ▼                   │
│     ┌────────────┐       ┌────────────┐       ┌────────────┐             │
│     │ GPU キュー  │       │ CPU キュー  │       │ API キュー  │             │
│     │            │       │            │       │            │             │
│     │ - 画像生成  │       │ - 音声合成  │       │ - BGM生成   │             │
│     │ - 動画生成  │       │ - テキスト  │       │ - 外部API   │             │
│     │ - 3D生成   │       │ - データ処理 │       │            │             │
│     └─────┬──────┘       └─────┬──────┘       └─────┬──────┘             │
│           │                    │                    │                     │
│           ▼                    ▼                    ▼                     │
│     ┌──────────┐         ┌──────────┐         ┌──────────┐              │
│     │ ComfyUI  │         │ VOICEVOX │         │ Suno     │              │
│     │ Worker   │         │ Worker   │         │ Worker   │              │
│     │ (×GPU数) │         │ (×複数)  │         │ (×1)     │              │
│     └──────────┘         ├──────────┤         └──────────┘              │
│                          │ Ollama   │                                    │
│                          │ Worker   │                                    │
│                          └──────────┘                                    │
│                                                                             │
│     ─────────────────────────────────────────────────────────────────     │
│     特徴:                                                                  │
│     - GPU処理は排他的 (VRAM競合回避)                                        │
│     - CPU処理は並列実行可能                                                 │
│     - API処理はレート制限に従う                                             │
│     - 各キューは独立して動作し続ける                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. フィードバックループ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           フィードバックループ                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│     ┌─────────────────────────────────────────────────────────────────┐   │
│     │                                                                 │   │
│     │    ┌────────┐      ┌────────┐      ┌────────┐                 │   │
│     │    │        │      │        │      │        │                 │   │
│     │    │  生成  │─────►│ レビュー │─────►│  改善  │                 │   │
│     │    │        │      │        │      │        │                 │   │
│     │    └────────┘      └────────┘      └───┬────┘                 │   │
│     │         ▲                              │                       │   │
│     │         │                              │                       │   │
│     │         └──────────────────────────────┘                       │   │
│     │                                                                 │   │
│     └─────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│     フィードバック経路:                                                      │
│                                                                             │
│     1. 自動フィードバック                                                   │
│        - 品質スコアが閾値以下 → 自動再生成                                  │
│        - 類似度チェック失敗 → 自動再生成                                    │
│                                                                             │
│     2. 人間フィードバック                                                   │
│        - _inbox/feedback/ にテキストファイル配置                            │
│        - システムが検知して再生成キューに追加                                │
│                                                                             │
│     3. バグ報告                                                            │
│        - _inbox/bugs/ に報告ファイル配置                                    │
│        - 優先度高でキューに追加                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 監視ダッシュボード

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ゲーム自動生成ダッシュボード                                      [■][□][×] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ■ 全体進捗                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  ████████████████░░░░░░░░░░░░░░░░  42% (168/400)                    │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ■ カテゴリ別                        ■ キュー状況                           │
│  ┌─────────────────────────────┐   ┌─────────────────────────────────┐  │
│  │ 画像     ████████░░░░ 67%   │   │ GPU:  ▶▶ 2実行中 / 15待機       │  │
│  │ 音声     ██████░░░░░░ 50%   │   │ CPU:  ▶▶▶▶ 4実行中 / 8待機     │  │
│  │ テキスト ██████████░░ 83%   │   │ API:  ▶ 1実行中 / 3待機         │  │
│  │ データ   ████░░░░░░░░ 33%   │   └─────────────────────────────────┘  │
│  └─────────────────────────────┘                                          │
│                                                                             │
│  ■ 最近の完了                        ■ 人間対応待ち                         │
│  ┌─────────────────────────────┐   ┌─────────────────────────────────┐  │
│  │ ✓ hero_happy.png            │   │ ! キャラデザイン方向性確認        │  │
│  │ ✓ bgm_battle.wav            │   │ ! ボス戦難易度の承認             │  │
│  │ ✓ dialog_chapter2.json      │   │                                  │  │
│  │ ✓ se_attack_sword.wav       │   │                                  │  │
│  └─────────────────────────────┘   └─────────────────────────────────┘  │
│                                                                             │
│  ■ エラー・警告                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ ⚠ ComfyUI Worker 1: VRAM不足で再試行中                              │  │
│  │ ⚠ Suno API: レート制限到達、待機中                                   │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. ディレクトリ構造

```
project/
│
├── _inbox/                     # 人間 → システム
│   ├── requests/               #   新規リクエスト
│   ├── feedback/               #   改善フィードバック
│   ├── bugs/                   #   バグ報告
│   └── approve/                #   承認アセット
│
├── _outbox/                    # システム → 人間
│   ├── pending_review/         #   レビュー待ち
│   ├── needs_human/            #   人間判断必要
│   └── reports/                #   レポート出力
│
├── config/                     # 設定
│   ├── project.yaml            #   ゲーム定義
│   ├── generation.yaml         #   生成パラメータ
│   └── workflows/              #   ComfyUIワークフロー
│
├── assets/                     # アセット格納
│   ├── approved/               #   承認済み（本番）
│   ├── generated/              #   生成済み（レビュー待ち）
│   ├── mock/                   #   モック
│   └── references/             #   参考資料
│
├── data/                       # 状態管理
│   ├── tasks.db                #   タスク状態DB
│   └── asset_registry.json     #   アセット状態
│
├── logs/                       # ログ
│
└── game/                       # ゲーム出力
    ├── src/
    └── build/
```

---

## 10. 運用フロー例

### 10.1 新規ゲーム開始

```
1. config/project.yaml を作成（ゲーム企画を記述）
2. システム起動: python run.py
3. モック版が自動生成される
4. バックグラウンドで本番生成開始
5. _outbox/pending_review/ に生成物が溜まっていく
6. 良いものは _inbox/approve/ に移動
7. 修正が必要なものは _inbox/feedback/ にコメント
```

### 10.2 日常の運用

```
朝:
  - _outbox/reports/daily_report.md を確認
  - _outbox/needs_human/ に対応が必要か確認

随時:
  - _outbox/pending_review/ を見て承認/フィードバック
  - 新しいアイデアは _inbox/requests/ に追加

夜:
  - システムは自動で生成を続ける
```

---

*作成日: 2026-01-14*
*バージョン: 3.0 (人間協働対応)*
