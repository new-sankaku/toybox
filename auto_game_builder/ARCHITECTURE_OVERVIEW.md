# ゲーム自動生成 全体アーキテクチャ

## 1. 設計コンセプト

### プログレッシブ生成アーキテクチャ

```
┌────────────────────────────────────────────────────────────────────┐
│                                                                    │
│   「モックで即座に動かし、裏で本番アセットを生成し続ける」           │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

時間軸:
─────────────────────────────────────────────────────────────────────►

[T=0]           [T=10分]         [T=1時間]        [T=完了]
   │               │                │               │
   ▼               ▼                ▼               ▼
┌──────┐      ┌──────┐         ┌──────┐        ┌──────┐
│モック │      │ 30%  │         │ 80%  │        │100%  │
│ゲーム │  →   │本番化│    →    │本番化│   →   │完成  │
│動作  │      │      │         │      │        │      │
└──────┘      └──────┘         └──────┘        └──────┘
   ↑               ↑                ↑
   │               │                │
 全アセット     画像/BGM        ボイス完了
 プレース       順次差替        全差替完了
 ホルダー
```

---

## 2. 全体システム構成図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ゲーム自動生成システム                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    1. 企画・設計レイヤー                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ ゲーム企画   │  │ アセット    │  │ タスク      │                  │   │
│  │  │ 定義        │→│ リスト生成  │→│ DAG生成     │                  │   │
│  │  │ (人間/LLM)  │  │ (LLM)       │  │ (自動)      │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    2. モック生成レイヤー (即時)                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────┐  │   │
│  │  │ プレース    │  │ ダミー      │  │ システム    │  │ 仮テキスト │  │   │
│  │  │ ホルダー画像│  │ サウンド    │  │ 音声        │  │ データ     │  │   │
│  │  │ (単色/図形) │  │ (Win標準)   │  │ (TTS簡易)   │  │ (テンプレ) │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └───────────┘  │   │
│  │                           │                                          │   │
│  │                           ▼                                          │   │
│  │              ┌─────────────────────────┐                            │   │
│  │              │   モック版ゲーム (即起動) │ ← 数分で動作確認可能      │   │
│  │              └─────────────────────────┘                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      │ (並行して実行)                       │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    3. 本番生成レイヤー (バックグラウンド)              │   │
│  │                                                                       │   │
│  │   ┌─────────┐    ┌─────────────────────────────────────────────┐    │   │
│  │   │  Task   │    │            ワーカープール                    │    │   │
│  │   │  Queue  │───►│  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐  │    │   │
│  │   │ (Redis) │    │  │ComfyUI│ │ComfyUI│ │VOICEVOX│ │Ollama │  │    │   │
│  │   └─────────┘    │  │(画像) │ │(動画) │ │(音声) │ │(テキスト)│  │    │   │
│  │        │         │  └───────┘ └───────┘ └───────┘ └───────┘  │    │   │
│  │        │         │       │         │         │         │      │    │   │
│  │        │         └───────┴─────────┴─────────┴─────────┘      │    │   │
│  │        │                             │                         │    │   │
│  │        ▼                             ▼                         │    │   │
│  │   ┌─────────┐              ┌─────────────────┐                │    │   │
│  │   │ 状態    │              │   生成済み       │                │    │   │
│  │   │ 管理DB  │              │   アセット格納   │                │    │   │
│  │   │         │              │   (ストレージ)   │                │    │   │
│  │   └─────────┘              └─────────────────┘                │    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    4. ホットスワップレイヤー                          │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ アセット    │  │ 差分検知    │  │ 自動        │                  │   │
│  │  │ 監視       │→│ & 検証      │→│ 差し替え    │                  │   │
│  │  │ (Watcher)  │  │ (Validator) │  │ (Swapper)   │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  │                                           │                          │   │
│  │                                           ▼                          │   │
│  │                           ┌─────────────────────────┐               │   │
│  │                           │ 本番版ゲーム (徐々に完成) │               │   │
│  │                           └─────────────────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. レイヤー詳細

### 3.1 企画・設計レイヤー

```
入力: ゲーム企画書 (人間 or LLM作成)
出力: 全アセットリスト + タスクDAG

┌─────────────────────────────────────────────────────────────────┐
│ game_project.yaml                                               │
├─────────────────────────────────────────────────────────────────┤
│ project:                                                        │
│   name: "勇者の冒険"                                             │
│   genre: "RPG"                                                  │
│   engine: "Unity"                                               │
│                                                                 │
│ characters:                                                     │
│   - id: hero                                                    │
│     name: "アレス"                                               │
│     role: "主人公"                                               │
│     expressions: [normal, happy, sad, angry, surprised]         │
│     outfits: [default, armor, casual]                          │
│                                                                 │
│   - id: heroine                                                 │
│     name: "リリア"                                               │
│     ...                                                         │
│                                                                 │
│ scenes:                                                         │
│   - id: title                                                   │
│   - id: village                                                 │
│   - id: forest                                                  │
│   - id: dungeon_1                                               │
│   ...                                                           │
│                                                                 │
│ audio:                                                          │
│   bgm_count: 10                                                 │
│   se_types: [attack, magic, ui, environment]                    │
│   voice: true                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ アセットリスト   │
                    │ 自動生成        │
                    │ (LLM解析)       │
                    └─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ generated_asset_list.json                                       │
├─────────────────────────────────────────────────────────────────┤
│ {                                                               │
│   "images": [                                                   │
│     {"id": "char_hero_normal", "type": "character", ...},       │
│     {"id": "char_hero_happy", "type": "expression", ...},       │
│     {"id": "bg_village", "type": "background", ...},            │
│     ...                                                         │
│   ],                                                            │
│   "audio": [                                                    │
│     {"id": "bgm_title", "type": "bgm", ...},                    │
│     {"id": "se_attack_sword", "type": "se", ...},               │
│     {"id": "voice_hero_001", "type": "voice", ...},             │
│     ...                                                         │
│   ],                                                            │
│   "data": [...]                                                 │
│ }                                                               │
│                                                                 │
│ 総アセット数: 847件                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 モック生成レイヤー

```
目的: 数分以内に「動くゲーム」を作る
方法: プレースホルダーで全アセットを即座に用意

┌─────────────────────────────────────────────────────────────────────────┐
│                        モックアセット生成戦略                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【画像系】                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ アセット種類      │ モック方式           │ 生成時間 │ ツール      │   │
│  ├───────────────────┼─────────────────────┼─────────┼────────────┤   │
│  │ キャラクター      │ 単色シルエット+名前  │ <1秒    │ Pillow     │   │
│  │ 背景             │ グラデーション+ラベル │ <1秒    │ Pillow     │   │
│  │ UI               │ ワイヤーフレーム      │ <1秒    │ Pillow     │   │
│  │ アイコン         │ 図形(丸/四角)+色分け  │ <1秒    │ Pillow     │   │
│  │ エフェクト       │ 半透明円/フラッシュ   │ <1秒    │ Pillow     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【音声系】                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ アセット種類      │ モック方式           │ 生成時間 │ ソース      │   │
│  ├───────────────────┼─────────────────────┼─────────┼────────────┤   │
│  │ BGM              │ Windows標準MIDI      │ 即時    │ SystemSound│   │
│  │                  │ or 無音ループ        │         │            │   │
│  │ SE (UI)          │ Windows標準音        │ 即時    │ MessageBeep│   │
│  │                  │ (ピッ、ポン等)       │         │            │   │
│  │ SE (攻撃等)      │ ビープ音バリエ       │ 即時    │ winsound   │   │
│  │ ボイス           │ 簡易TTS or 無音      │ <1秒    │ pyttsx3    │   │
│  │                  │ (テキスト表示で代替) │         │            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【データ系】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ アセット種類      │ モック方式           │ 生成時間 │ 方法        │   │
│  ├───────────────────┼─────────────────────┼─────────┼────────────┤   │
│  │ シナリオ         │ "[シナリオ生成中]"   │ 即時    │ テンプレート│   │
│  │ ダイアログ       │ "キャラ名: ..."     │ 即時    │ テンプレート│   │
│  │ パラメータ       │ 仮数値 (全て100等)   │ 即時    │ デフォルト  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**モック画像例:**

```
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ ■■■■■■■■■■■■■ │  │ ░░░░░░░░░░░░░░░ │  │ ┌─────────────┐ │
│ ■■■■■■■■■■■■■ │  │ ░░░░░░░░░░░░░░░ │  │ │   [決定]    │ │
│ ■■  HERO  ■■■ │  │ ░░  FOREST  ░░░ │  │ └─────────────┘ │
│ ■■■■■■■■■■■■■ │  │ ░░░░░░░░░░░░░░░ │  │ ┌─────────────┐ │
│ ■■■■■■■■■■■■■ │  │ ░░░░░░░░░░░░░░░ │  │ │  [キャンセル] │ │
│ ■■■■■■■■■■■■■ │  │ ░░░░░░░░░░░░░░░ │  │ └─────────────┘ │
└─────────────────┘  └─────────────────┘  └─────────────────┘
  キャラモック         背景モック           UIモック
  (青色 + 名前)       (緑グラデ + 名前)    (ワイヤーフレーム)
```

### 3.3 本番生成レイヤー

```
目的: バックグラウンドで本番アセットを生成し続ける
特徴: モック版の動作を止めない、優先度に基づく生成

┌─────────────────────────────────────────────────────────────────────────┐
│                        生成優先度キュー                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  優先度 HIGH (先に生成)                                                  │
│  ├── タイトル画面素材 (最初に目に入る)                                   │
│  ├── メインキャラ立ち絵 (基本表情)                                       │
│  ├── 最初のマップ背景                                                    │
│  └── タイトルBGM                                                        │
│                                                                         │
│  優先度 MEDIUM                                                          │
│  ├── サブキャラ立ち絵                                                    │
│  ├── 表情差分                                                           │
│  ├── 各マップ背景                                                        │
│  ├── 戦闘BGM                                                            │
│  └── 主要SE                                                             │
│                                                                         │
│  優先度 LOW (後回し)                                                     │
│  ├── 衣装差分                                                           │
│  ├── エフェクト                                                         │
│  ├── 環境音                                                             │
│  └── サブクエスト用ボイス                                                │
│                                                                         │
│  優先度 BACKGROUND (空き時間に)                                          │
│  ├── ギャラリー用高解像度版                                              │
│  ├── 追加バリエーション                                                  │
│  └── 将来の拡張用アセット                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                        並列生成パイプライン                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         時間軸                                   │   │
│  │  ─────────────────────────────────────────────────────────────► │   │
│  │                                                                  │   │
│  │  GPU-0 (ComfyUI): [画像1][画像2][画像3][画像4][画像5]...        │   │
│  │                   ├──30s─┤├──30s─┤├──30s─┤├──30s─┤              │   │
│  │                                                                  │   │
│  │  CPU-1 (VOICEVOX): [V1][V2][V3][V4][V5][V6][V7][V8][V9]...      │   │
│  │                    ├2s┤├2s┤├2s┤├2s┤├2s┤├2s┤├2s┤├2s┤            │   │
│  │                                                                  │   │
│  │  CPU-2 (Ollama):   [シナリオ生成─────][ダイアログ──][設定─]      │   │
│  │                    ├────60s────────┤├───30s──┤├─20s─┤           │   │
│  │                                                                  │   │
│  │  API (Suno):       [BGM1──────][BGM2──────][BGM3──────]         │   │
│  │                    ├───120s───┤├───120s───┤├───120s───┤         │   │
│  │                                                                  │   │
│  │  → 全ワーカーが同時並行で稼働し続ける                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4 ホットスワップレイヤー

```
目的: 生成完了したアセットを動作中のゲームにシームレスに反映
方式: ファイル監視 + アセット参照の抽象化

┌─────────────────────────────────────────────────────────────────────────┐
│                        ホットスワップ機構                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   アセットマネージャー                            │   │
│  │                                                                   │   │
│  │   ゲームコード                    アセット格納                    │   │
│  │       │                               │                          │   │
│  │       ▼                               │                          │   │
│  │   ┌─────────┐                         │                          │   │
│  │   │ Asset   │    ┌─────────┐          │                          │   │
│  │   │ Manager │◄───│ Watcher │◄─────────┤                          │   │
│  │   │         │    └─────────┘          │                          │   │
│  │   └────┬────┘         │               │                          │   │
│  │        │              │               ▼                          │   │
│  │        │         ファイル変更     ┌─────────┐                    │   │
│  │        │         検知            │ assets/ │                    │   │
│  │        │                         │ ├─mock/ │ ← モック           │   │
│  │        │                         │ └─prod/ │ ← 本番             │   │
│  │        ▼                         └─────────┘                    │   │
│  │   ┌─────────────────────────────────────┐                       │   │
│  │   │ asset_registry.json                 │                       │   │
│  │   │ {                                   │                       │   │
│  │   │   "char_hero_normal": {             │                       │   │
│  │   │     "mock": "mock/char_hero.png",   │                       │   │
│  │   │     "prod": "prod/char_hero.png",   │ ← 生成完了時に更新   │   │
│  │   │     "status": "ready"               │                       │   │
│  │   │   },                                │                       │   │
│  │   │   "bgm_title": {                    │                       │   │
│  │   │     "mock": "mock/silence.wav",     │                       │   │
│  │   │     "prod": null,                   │ ← まだ未生成         │   │
│  │   │     "status": "generating"          │                       │   │
│  │   │   }                                 │                       │   │
│  │   │ }                                   │                       │   │
│  │   └─────────────────────────────────────┘                       │   │
│  │                                                                   │   │
│  │   // ゲームコード側の呼び出し                                      │   │
│  │   image = AssetManager.get("char_hero_normal")                   │   │
│  │   // → 本番があれば本番、なければモックを返す                      │   │
│  │                                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. データフロー全体図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│    [入力]                                                                   │
│    ゲーム企画書                                                              │
│        │                                                                    │
│        ▼                                                                    │
│    ┌───────────────┐                                                       │
│    │ 1.企画解析    │ ← LLM (Ollama)                                        │
│    │   (5分)       │                                                        │
│    └───────────────┘                                                       │
│        │                                                                    │
│        ├──────────────────┬──────────────────┐                             │
│        ▼                  ▼                  ▼                             │
│    ┌─────────┐      ┌─────────────┐    ┌─────────────┐                    │
│    │アセット │      │ タスクDAG   │    │ ゲーム      │                    │
│    │リスト   │      │ 生成        │    │ テンプレート │                    │
│    │(847件) │      │             │    │ 選択        │                    │
│    └─────────┘      └─────────────┘    └─────────────┘                    │
│        │                  │                  │                             │
│        │                  │                  │                             │
│        ▼                  │                  │                             │
│    ┌───────────────┐      │                  │                             │
│    │ 2.モック生成  │      │                  │                             │
│    │   (3分)       │      │                  │                             │
│    └───────────────┘      │                  │                             │
│        │                  │                  │                             │
│        ├──────────────────┼──────────────────┤                             │
│        ▼                  ▼                  ▼                             │
│    ┌─────────────────────────────────────────────────┐                    │
│    │           3. モック版ゲーム起動                  │                    │
│    │              (開始から約10分)                    │ ← 即座にプレイ可能 │
│    └─────────────────────────────────────────────────┘                    │
│                           │                                                │
│                           │ 並行実行                                       │
│                           ▼                                                │
│    ┌─────────────────────────────────────────────────┐                    │
│    │           4. 本番アセット生成                    │                    │
│    │              (バックグラウンド継続)              │                    │
│    │                                                 │                    │
│    │   ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐            │                    │
│    │   │画像 │ │音声 │ │BGM  │ │テキスト│            │                    │
│    │   │生成 │ │生成 │ │生成 │ │生成  │            │                    │
│    │   └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘            │                    │
│    │      │       │       │       │                │                    │
│    │      └───────┴───────┴───────┘                │                    │
│    │                  │                            │                    │
│    └──────────────────┼────────────────────────────┘                    │
│                       │                                                   │
│                       ▼                                                   │
│    ┌─────────────────────────────────────────────────┐                   │
│    │           5. ホットスワップ                      │                   │
│    │              (随時差し替え)                      │                   │
│    └─────────────────────────────────────────────────┘                   │
│                       │                                                   │
│                       ▼                                                   │
│    ┌─────────────────────────────────────────────────┐                   │
│    │           6. 本番版ゲーム完成                    │                   │
│    │              (数時間後)                          │                   │
│    └─────────────────────────────────────────────────┘                   │
│                                                                          │
│    [出力]                                                                 │
│    完成ゲーム                                                             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 処理時間の見積もり

### シンプルなRPG (アセット500件) の場合

```
┌─────────────────────────────────────────────────────────────────────────┐
│ フェーズ            │ 処理内容              │ 時間        │ 状態       │
├─────────────────────┼──────────────────────┼────────────┼───────────┤
│ 1. 企画解析         │ LLMでアセットリスト化 │ 5分        │ 必須待ち   │
│ 2. モック生成       │ プレースホルダー作成  │ 3分        │ 必須待ち   │
│ 3. モック版起動     │ ゲーム動作開始        │ 10分時点   │ ▶ プレイ可 │
├─────────────────────┼──────────────────────┼────────────┼───────────┤
│ 4-a. 画像生成       │ 200枚 × 30秒        │ 100分      │ 並列実行   │
│ 4-b. ボイス生成     │ 500件 × 2秒         │ 17分       │ 並列実行   │
│ 4-c. BGM生成        │ 10曲 × 2分          │ 20分       │ 並列実行   │
│ 4-d. テキスト生成   │ シナリオ等           │ 30分       │ 並列実行   │
├─────────────────────┼──────────────────────┼────────────┼───────────┤
│ 5. 全アセット完成   │                      │ 約2時間    │ ◎ 完成    │
└─────────────────────┴──────────────────────┴────────────┴───────────┘

※ 画像生成がボトルネック (GPU 1枚の場合)
※ GPU 2枚なら約1時間に短縮
```

---

## 6. ディレクトリ構造

```
game_project/
├── config/
│   ├── project.yaml           # ゲーム企画定義
│   └── generation_config.yaml # 生成パラメータ
│
├── assets/
│   ├── mock/                  # モックアセット (即時生成)
│   │   ├── images/
│   │   ├── audio/
│   │   └── data/
│   │
│   ├── prod/                  # 本番アセット (AI生成)
│   │   ├── images/
│   │   ├── audio/
│   │   └── data/
│   │
│   └── registry.json          # アセット状態管理
│
├── src/                       # ゲームソースコード
│   ├── core/
│   ├── scenes/
│   └── utils/
│       └── asset_manager.py   # ホットスワップ対応
│
├── generation/                # 生成システム
│   ├── orchestrator/
│   ├── workers/
│   ├── workflows/             # ComfyUIワークフロー
│   └── templates/             # プロンプトテンプレート
│
├── tools/
│   ├── mock_generator.py      # モック生成ツール
│   └── hot_swap_daemon.py     # ホットスワップデーモン
│
└── output/                    # ビルド出力
    └── game_build/
```

---

## 7. 技術スタック選定

```
┌─────────────────────────────────────────────────────────────────────────┐
│ レイヤー           │ 技術                      │ 理由                  │
├───────────────────┼─────────────────────────┼──────────────────────┤
│ オーケストレーション │ Python + asyncio         │ 非同期処理、統合容易  │
│ タスクキュー       │ Redis + rq               │ シンプル、実績あり    │
│ 状態管理          │ SQLite / PostgreSQL      │ 軽量 or スケーラブル  │
│ 画像生成          │ ComfyUI API              │ 柔軟、ローカル実行    │
│ 音声生成          │ VOICEVOX Engine API      │ 高品質日本語、無料    │
│ BGM生成           │ Suno (Web) / MusicGen    │ 品質重視 / ローカル   │
│ テキスト生成       │ Ollama (Llama3/Qwen)    │ ローカル、無制限      │
│ モック画像         │ Pillow                   │ 高速、シンプル        │
│ モック音声         │ winsound / pyttsx3      │ OS標準、即時          │
│ ファイル監視       │ watchdog                 │ クロスプラットフォーム │
│ ゲームエンジン     │ Unity / Godot / Pygame   │ プロジェクトによる    │
└───────────────────┴─────────────────────────┴──────────────────────┘
```

---

## 8. 次のステップ

1. [ ] モック生成モジュールの実装
2. [ ] アセットマネージャーの実装
3. [ ] ホットスワップデーモンの実装
4. [ ] オーケストレーターの実装
5. [ ] ComfyUIワーカーの実装
6. [ ] 統合テスト

---

*作成日: 2026-01-14*
*アーキテクチャバージョン: 2.0 (プログレッシブ生成対応)*
