# マルチエージェント ゲーム生成アーキテクチャ

## 1. 設計思想

```
┌────────────────────────────────────────────────────────────────────┐
│                                                                    │
│   各専門分野にAgentを配置し、並列で自律的に動作させる                 │
│                                                                    │
│   - 各Agentは自分の責務に集中する                                    │
│   - Agent間はメッセージで疎結合に連携                                │
│   - 依存関係がないタスクは完全並列実行                               │
│   - 共有データストアで成果物を共有                                   │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## 2. Agent一覧と責務

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Agent 構成図                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         ┌─────────────────┐                                │
│                         │  Director Agent │ ← 全体統括・意思決定            │
│                         │  (指揮者)        │                                │
│                         └────────┬────────┘                                │
│                                  │                                          │
│          ┌───────────────────────┼───────────────────────┐                 │
│          │                       │                       │                 │
│          ▼                       ▼                       ▼                 │
│   ┌────────────┐         ┌────────────┐         ┌────────────┐            │
│   │ Planning   │         │ Production │         │ Integration│            │
│   │ Agents     │         │ Agents     │         │ Agent      │            │
│   │ (企画系)    │         │ (制作系)    │         │ (統合)      │            │
│   └────────────┘         └────────────┘         └────────────┘            │
│         │                       │                       │                 │
│   ┌─────┴─────┐     ┌──────────┼──────────┐            │                 │
│   │           │     │          │          │            │                 │
│   ▼           ▼     ▼          ▼          ▼            ▼                 │
│ ┌─────┐   ┌─────┐ ┌─────┐  ┌─────┐  ┌─────┐     ┌─────────┐            │
│ │World│   │Scenario│ │Visual│  │Audio│  │Code │     │ Build   │            │
│ │Agent│   │Agent│ │Agent│  │Agent│  │Agent│     │ Agent   │            │
│ └─────┘   └─────┘ └─────┘  └─────┘  └─────┘     └─────────┘            │
│                       │                                                    │
│               ┌───────┴───────┐                                           │
│               │               │                                           │
│               ▼               ▼                                           │
│           ┌─────┐         ┌─────┐                                        │
│           │Chara│         │ BG  │                                        │
│           │Agent│         │Agent│                                        │
│           └─────┘         └─────┘                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.1 各Agentの詳細

| Agent名 | 責務 | 入力 | 出力 | 使用ツール |
|---------|------|------|------|-----------|
| **Director** | 全体統括、進捗管理、意思決定 | 企画書、進捗状況 | 指示、承認 | - |
| **World** | 世界観設定、用語定義 | 企画書 | 世界観設定JSON | Ollama |
| **Scenario** | シナリオ、ダイアログ作成 | 世界観、キャラ設定 | シナリオJSON | Ollama |
| **Character** | キャラ設定、キャラ画像生成 | 世界観 | キャラ設定、画像 | Ollama, ComfyUI |
| **Background** | 背景画像生成 | 世界観、シーン情報 | 背景画像 | ComfyUI |
| **Audio** | BGM、SE、ボイス生成 | シナリオ、シーン情報 | 音声ファイル | Suno, VOICEVOX |
| **Code** | ゲームロジック実装 | 設計、データ | ソースコード | Ollama |
| **Build** | ビルド、統合、テスト | 全アセット | 実行可能ゲーム | ビルドツール |

---

## 3. Agent間通信アーキテクチャ

### 3.1 メッセージバス構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           メッセージバス (Redis Pub/Sub)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        Message Bus                                   │  │
│   │  ┌─────────────────────────────────────────────────────────────┐    │  │
│   │  │  Channels:                                                   │    │  │
│   │  │   - world.created      (世界観作成完了)                       │    │  │
│   │  │   - character.created  (キャラ設定完了)                       │    │  │
│   │  │   - character.image.created (キャラ画像完了)                  │    │  │
│   │  │   - scenario.created   (シナリオ完了)                         │    │  │
│   │  │   - background.created (背景画像完了)                         │    │  │
│   │  │   - audio.bgm.created  (BGM完了)                             │    │  │
│   │  │   - audio.voice.created (ボイス完了)                         │    │  │
│   │  │   - code.created       (コード完了)                          │    │  │
│   │  │   - feedback.received  (人間フィードバック受信)               │    │  │
│   │  │   - error.occurred     (エラー発生)                          │    │  │
│   │  └─────────────────────────────────────────────────────────────┘    │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│          ▲           ▲           ▲           ▲           ▲               │
│          │           │           │           │           │               │
│    ┌─────┴───┐ ┌─────┴───┐ ┌─────┴───┐ ┌─────┴───┐ ┌─────┴───┐         │
│    │  World  │ │Character│ │Scenario │ │  Audio  │ │  Code   │         │
│    │  Agent  │ │  Agent  │ │  Agent  │ │  Agent  │ │  Agent  │         │
│    └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 メッセージ形式

```python
# メッセージ構造
{
    "id": "msg_001",
    "type": "character.created",
    "source": "character_agent",
    "timestamp": "2024-01-15T10:30:00Z",
    "payload": {
        "character_id": "hero",
        "name": "アレス",
        "assets": {
            "settings": "data/characters/hero/settings.json",
            "image_normal": "assets/characters/hero/normal.png",
            "image_happy": "assets/characters/hero/happy.png"
        }
    },
    "dependencies_resolved": ["world.created"]
}
```

---

## 4. 依存関係グラフ (DAG)

### 4.1 タスク依存関係

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         タスク依存関係グラフ                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────┐                                                             │
│   │ 企画書   │ (入力)                                                      │
│   └────┬─────┘                                                             │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────┐                                                             │
│   │ World    │ ─────────────────────────────────────────┐                  │
│   │ Agent    │                                          │                  │
│   └────┬─────┘                                          │                  │
│        │                                                │                  │
│        │ world.created                                  │                  │
│        │                                                │                  │
│   ┌────┴─────────────────────────┐                      │                  │
│   │                              │                      │                  │
│   ▼                              ▼                      ▼                  │
│ ┌──────────┐              ┌──────────┐           ┌──────────┐             │
│ │Character │              │ Scenario │           │   BGM    │             │
│ │ Agent    │              │  Agent   │           │  (Audio) │             │
│ │          │              │          │           │          │             │
│ │ キャラ設定 │              │ プロット  │           │ タイトル曲│             │
│ └────┬─────┘              └────┬─────┘           └──────────┘             │
│      │                         │                       ▲                   │
│      │ character.created       │ scenario.plot.created │                   │
│      │                         │                       │                   │
│ ┌────┴────┐              ┌─────┴─────┐                 │                   │
│ │         │              │           │                 │                   │
│ ▼         ▼              ▼           ▼                 │                   │
│┌────┐  ┌────┐      ┌──────────┐ ┌──────────┐          │                   │
││立ち絵│  │表情│      │ダイアログ │ │ シーン詳細│           │                   │
││生成 │  │差分│      │  生成   │ │   生成   │           │                   │
│└──┬─┘  └─┬──┘      └────┬─────┘ └────┬─────┘          │                   │
│   │      │              │           │                 │                   │
│   │      │              │           │                 │                   │
│   │      │         ┌────┴───────────┴────┐            │                   │
│   │      │         │                     │            │                   │
│   │      │         ▼                     ▼            │                   │
│   │      │    ┌──────────┐         ┌──────────┐       │                   │
│   │      │    │  Voice   │         │背景画像   │       │                   │
│   │      │    │  生成    │         │  生成    │       │                   │
│   │      │    └────┬─────┘         └────┬─────┘       │                   │
│   │      │         │                    │             │                   │
│   └──────┴─────────┴────────────────────┴─────────────┘                   │
│                              │                                             │
│                              ▼                                             │
│                       ┌──────────┐                                        │
│                       │  Build   │                                        │
│                       │  Agent   │                                        │
│                       └──────────┘                                        │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────   │
│   凡例:                                                                    │
│     → 依存関係 (上が完了しないと下は開始できない)                           │
│     同じレベルにあるものは並列実行可能                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 並列実行可能なタスクグループ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         並列実行グループ                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Phase 1: 初期化 (並列度: 1)                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ [World Agent] 世界観生成                                             │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│   Phase 2: 基盤生成 (並列度: 3)                                             │
│   ┌─────────────────┬─────────────────┬─────────────────┐                 │
│   │ [Character]     │ [Scenario]      │ [Audio]         │                 │
│   │  キャラ設定生成  │  プロット生成    │  BGM生成開始     │                 │
│   └─────────────────┴─────────────────┴─────────────────┘                 │
│          │                    │                                             │
│          ▼                    ▼                                             │
│   Phase 3: アセット生成 (並列度: 5+)                                         │
│   ┌───────────┬───────────┬───────────┬───────────┬───────────┐           │
│   │ キャラ    │ 表情差分  │ ダイアログ │ 背景画像   │ SE生成   │           │
│   │ 立ち絵   │ 生成      │ 生成      │ 生成      │          │           │
│   └───────────┴───────────┴───────────┴───────────┴───────────┘           │
│                    │                                                        │
│                    ▼                                                        │
│   Phase 4: 依存アセット (並列度: 3)                                          │
│   ┌─────────────────┬─────────────────┬─────────────────┐                 │
│   │ ボイス生成      │ エフェクト生成   │ UIアセット生成  │                 │
│   │ (ダイアログ依存) │                 │                 │                 │
│   └─────────────────┴─────────────────┴─────────────────┘                 │
│                                      │                                      │
│                                      ▼                                      │
│   Phase 5: 統合 (並列度: 1)                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ [Build Agent] 統合・ビルド・テスト                                    │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 共有データストア

### 5.1 構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            共有データストア                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         Data Store                                   │  │
│   │                                                                      │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │  │
│   │  │  Settings   │  │   Assets    │  │   State     │                 │  │
│   │  │  (設定)     │  │  (成果物)   │  │  (状態)     │                 │  │
│   │  │             │  │             │  │             │                 │  │
│   │  │ - world.json│  │ - images/   │  │ - tasks.db  │                 │  │
│   │  │ - chars.json│  │ - audio/    │  │ - agents.db │                 │  │
│   │  │ - story.json│  │ - data/     │  │ - events.log│                 │  │
│   │  │             │  │             │  │             │                 │  │
│   │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                 │  │
│   │         │                │                │                         │  │
│   │         └────────────────┴────────────────┘                         │  │
│   │                          │                                          │  │
│   │                          ▼                                          │  │
│   │              ┌──────────────────────┐                              │  │
│   │              │   Unified API        │                              │  │
│   │              │   (読み書きI/F)       │                              │  │
│   │              └──────────────────────┘                              │  │
│   │                          ▲                                          │  │
│   └──────────────────────────┼──────────────────────────────────────────┘  │
│                              │                                             │
│       ┌──────────────────────┼──────────────────────┐                     │
│       │                      │                      │                     │
│       ▼                      ▼                      ▼                     │
│   ┌─────────┐          ┌─────────┐          ┌─────────┐                  │
│   │Character│          │Scenario │          │  Audio  │                  │
│   │ Agent   │          │ Agent   │          │  Agent  │                  │
│   └─────────┘          └─────────┘          └─────────┘                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 データアクセスパターン

```python
# 各Agentはデータストアを通じて他Agentの成果物を参照

class DataStore:
    def get_world_settings(self) -> WorldSettings:
        """世界観設定を取得（World Agentが書き込んだもの）"""
        pass

    def get_character(self, char_id: str) -> Character:
        """キャラ情報を取得（Character Agentが書き込んだもの）"""
        pass

    def get_scenario(self) -> Scenario:
        """シナリオを取得（Scenario Agentが書き込んだもの）"""
        pass

    def save_asset(self, asset_type: str, asset_id: str, data: bytes):
        """成果物を保存"""
        pass

# 使用例: Scenario AgentがCharacter情報を参照
class ScenarioAgent:
    async def generate_dialog(self):
        # Character Agentが作成したキャラ情報を取得
        hero = self.datastore.get_character("hero")
        heroine = self.datastore.get_character("heroine")

        # キャラの性格に基づいてダイアログ生成
        dialog = await self.llm.generate(
            f"{hero.name}は{hero.personality}な性格で..."
        )
```

---

## 6. Agent実装詳細

### 6.1 基底Agentクラス

```python
# agents/base.py

class BaseAgent:
    def __init__(self, agent_id: str, message_bus: MessageBus, datastore: DataStore):
        self.agent_id = agent_id
        self.bus = message_bus
        self.datastore = datastore
        self.state = AgentState.IDLE
        self.subscriptions = []

    async def start(self):
        """Agent起動"""
        # 依存するイベントを購読
        for event_type in self.get_dependencies():
            self.bus.subscribe(event_type, self.on_dependency_resolved)

        # 初期タスクがあれば開始
        if not self.get_dependencies():
            await self.run()

    def get_dependencies(self) -> List[str]:
        """このAgentが依存するイベントタイプ"""
        return []  # オーバーライド

    async def on_dependency_resolved(self, message: Message):
        """依存イベント受信時"""
        if self.all_dependencies_resolved():
            await self.run()

    async def run(self):
        """メイン処理（オーバーライド）"""
        raise NotImplementedError

    async def publish(self, event_type: str, payload: dict):
        """イベント発行"""
        await self.bus.publish(Message(
            type=event_type,
            source=self.agent_id,
            payload=payload
        ))
```

### 6.2 具体的なAgent実装

```python
# agents/world_agent.py

class WorldAgent(BaseAgent):
    """世界観設定を生成するAgent"""

    def get_dependencies(self):
        return []  # 依存なし、最初に実行

    async def run(self):
        self.state = AgentState.RUNNING

        # 企画書から世界観を生成
        project = self.datastore.get_project_config()

        world_settings = await self.llm.generate(
            template="world_building",
            inputs={"genre": project.genre, "theme": project.theme}
        )

        # 保存
        self.datastore.save_world_settings(world_settings)

        # 完了通知
        await self.publish("world.created", {
            "world_id": world_settings.id,
            "path": "data/world/settings.json"
        })

        self.state = AgentState.COMPLETED


# agents/character_agent.py

class CharacterAgent(BaseAgent):
    """キャラクター設定と画像を生成するAgent"""

    def get_dependencies(self):
        return ["world.created"]  # World完了後に開始

    async def run(self):
        self.state = AgentState.RUNNING

        # 世界観を参照
        world = self.datastore.get_world_settings()
        project = self.datastore.get_project_config()

        # 各キャラクターを並列生成
        tasks = []
        for char_def in project.characters:
            tasks.append(self.generate_character(char_def, world))

        await asyncio.gather(*tasks)

        self.state = AgentState.COMPLETED

    async def generate_character(self, char_def, world):
        # キャラ設定生成 (LLM)
        settings = await self.llm.generate(
            template="character_design",
            inputs={"name": char_def.name, "role": char_def.role, "world": world}
        )
        self.datastore.save_character(char_def.id, settings)

        # 立ち絵生成 (ComfyUI)
        image = await self.comfyui.generate(
            workflow="character_portrait",
            params={"prompt": settings.visual_description}
        )
        self.datastore.save_asset("image", f"{char_def.id}_normal", image)

        # 完了通知
        await self.publish("character.created", {
            "character_id": char_def.id,
            "settings_path": f"data/characters/{char_def.id}.json",
            "image_path": f"assets/characters/{char_def.id}_normal.png"
        })


# agents/scenario_agent.py

class ScenarioAgent(BaseAgent):
    """シナリオを生成するAgent"""

    def get_dependencies(self):
        return ["world.created"]  # World完了後に開始

    async def run(self):
        self.state = AgentState.RUNNING

        world = self.datastore.get_world_settings()

        # プロット生成
        plot = await self.generate_plot(world)
        await self.publish("scenario.plot.created", {"plot": plot})

        # キャラ情報を待つ（並列で生成されている）
        characters = await self.wait_for("character.created", count=expected_count)

        # ダイアログ生成
        dialogs = await self.generate_dialogs(plot, characters)

        await self.publish("scenario.created", {
            "plot_path": "data/scenario/plot.json",
            "dialogs_path": "data/scenario/dialogs.json"
        })

        self.state = AgentState.COMPLETED
```

---

## 7. 並列実行エンジン

### 7.1 オーケストレーター

```python
# orchestrator/engine.py

class ParallelExecutionEngine:
    def __init__(self):
        self.message_bus = MessageBus()
        self.datastore = DataStore()
        self.agents = {}
        self.task_graph = TaskGraph()

    def register_agent(self, agent_class, agent_id):
        """Agentを登録"""
        agent = agent_class(agent_id, self.message_bus, self.datastore)
        self.agents[agent_id] = agent
        return agent

    async def run(self, project_config):
        """プロジェクト実行"""
        self.datastore.save_project_config(project_config)

        # 全Agentを起動（各自が依存関係を見て待機/実行する）
        await asyncio.gather(*[
            agent.start() for agent in self.agents.values()
        ])

    def get_status(self):
        """現在の状態を取得"""
        return {
            agent_id: agent.state
            for agent_id, agent in self.agents.items()
        }
```

### 7.2 実行フロー可視化

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           実行タイムライン                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  時間 →                                                                     │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  World Agent    ████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  │
│                 └─ world.created                                            │
│                            │                                                │
│                            ▼                                                │
│  Character Agent░░░░░░░░░░████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░  │
│                            └─ character.created (hero)                      │
│                                 └─ character.created (heroine)              │
│                                                                             │
│  Scenario Agent ░░░░░░░░░░████████████████████████████░░░░░░░░░░░░░░░░░░░  │
│                            └─ scenario.plot.created                         │
│                                              └─ scenario.created            │
│                                                                             │
│  Audio Agent    ░░░░░░░░░░██████████████████████████████████████░░░░░░░░░  │
│                            └─ BGM生成開始（依存なし）                         │
│                                                    └─ audio.bgm.created    │
│                                                                             │
│  Background Agent░░░░░░░░░░░░░░░░░░░░░░░░░████████████████████░░░░░░░░░░░  │
│                                           └─ シーン情報を待って開始          │
│                                                                             │
│  Voice Agent    ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░██████████████████████░░  │
│                                                  └─ ダイアログ完了後開始     │
│                                                                             │
│  Build Agent    ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░████████  │
│                                                                  └─ 全完了後 │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│  ████ = 実行中   ░░░ = 待機中                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Agent間の整合性確保

### 8.1 整合性チェックAgent

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         整合性チェック機構                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    Consistency Checker                               │  │
│   │                                                                      │  │
│   │   監視対象:                                                          │  │
│   │   ┌─────────────────────────────────────────────────────────────┐   │  │
│   │   │ 1. キャラ名の一貫性                                          │   │  │
│   │   │    - シナリオ内のキャラ名 ⟷ キャラ設定の名前                   │   │  │
│   │   │                                                              │   │  │
│   │   │ 2. 世界観の整合性                                            │   │  │
│   │   │    - 背景のスタイル ⟷ 世界観設定                              │   │  │
│   │   │    - BGMのムード ⟷ シーンの雰囲気                             │   │  │
│   │   │                                                              │   │  │
│   │   │ 3. リソース参照の整合性                                       │   │  │
│   │   │    - シナリオが参照するアセット ⟷ 実際のアセット存在           │   │  │
│   │   │                                                              │   │  │
│   │   │ 4. データ形式の整合性                                         │   │  │
│   │   │    - JSON schemaバリデーション                                │   │  │
│   │   └─────────────────────────────────────────────────────────────┘   │  │
│   │                                                                      │  │
│   │   不整合検出時:                                                      │  │
│   │   → 関係するAgentに修正リクエスト送信                                │  │
│   │   → または人間に判断を仰ぐ (_outbox/needs_human/)                   │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 修正フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           修正フロー                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   不整合検出                                                                │
│        │                                                                    │
│        ▼                                                                    │
│   ┌─────────────────┐                                                      │
│   │ 自動修正可能？  │                                                      │
│   └────────┬────────┘                                                      │
│            │                                                                │
│     ┌──────┴──────┐                                                        │
│     │             │                                                        │
│    Yes           No                                                        │
│     │             │                                                        │
│     ▼             ▼                                                        │
│ ┌─────────┐  ┌─────────────┐                                              │
│ │影響範囲  │  │ 人間に通知   │                                              │
│ │を特定   │  │             │                                              │
│ └────┬────┘  └──────┬──────┘                                              │
│      │              │                                                      │
│      ▼              ▼                                                      │
│ ┌─────────┐  ┌─────────────┐                                              │
│ │該当Agent│  │ _outbox/     │                                              │
│ │に再生成 │  │ needs_human/ │                                              │
│ │リクエスト│  │ に配置      │                                              │
│ └────┬────┘  └──────┬──────┘                                              │
│      │              │                                                      │
│      ▼              ▼                                                      │
│ ┌─────────┐  ┌─────────────┐                                              │
│ │自動再生成│  │人間が判断    │                                              │
│ │         │  │& 修正指示   │                                              │
│ └─────────┘  └─────────────┘                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 全体システム構成図

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              ゲーム自動生成システム 全体構成                               │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│    ┌─────────────┐                                                                     │
│    │   Human     │                                                                     │
│    │  Interface  │                                                                     │
│    └──────┬──────┘                                                                     │
│           │                                                                             │
│           ▼                                                                             │
│    ┌─────────────────────────────────────────────────────────────────────────────┐     │
│    │                           _inbox / _outbox                                   │     │
│    │   (フォルダベースの人間↔システム インターフェース)                            │     │
│    └─────────────────────────────────────────────────────────────────────────────┘     │
│           │                                                                             │
│           ▼                                                                             │
│    ┌─────────────────────────────────────────────────────────────────────────────┐     │
│    │                         Director Agent (統括)                                │     │
│    │   - 全体進捗監視                                                             │     │
│    │   - 人間フィードバック処理                                                    │     │
│    │   - 最終承認                                                                 │     │
│    └─────────────────────────────────────────────────────────────────────────────┘     │
│           │                                                                             │
│           ▼                                                                             │
│    ┌─────────────────────────────────────────────────────────────────────────────┐     │
│    │                    Message Bus (Redis Pub/Sub)                               │     │
│    │                     Agent間イベント通信基盤                                   │     │
│    └─────────────────────────────────────────────────────────────────────────────┘     │
│           │                                                                             │
│           ├───────────────┬───────────────┬───────────────┬───────────────┐           │
│           ▼               ▼               ▼               ▼               ▼           │
│    ┌───────────┐   ┌───────────┐   ┌───────────┐   ┌───────────┐   ┌───────────┐     │
│    │   World   │   │ Character │   │ Scenario  │   │   Audio   │   │   Code    │     │
│    │   Agent   │   │   Agent   │   │   Agent   │   │   Agent   │   │   Agent   │     │
│    │           │   │           │   │           │   │           │   │           │     │
│    │ [Ollama]  │   │ [Ollama]  │   │ [Ollama]  │   │ [VOICEVOX]│   │ [Ollama]  │     │
│    │           │   │ [ComfyUI] │   │           │   │ [Suno]    │   │           │     │
│    └───────────┘   └───────────┘   └───────────┘   └───────────┘   └───────────┘     │
│           │               │               │               │               │           │
│           └───────────────┴───────────────┴───────────────┴───────────────┘           │
│                                           │                                             │
│                                           ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────────────────┐     │
│    │                         Data Store (共有データ)                              │     │
│    │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │     │
│    │   │  Settings   │  │   Assets    │  │   State     │  │    Logs     │       │     │
│    │   │  (JSON)     │  │  (Files)    │  │  (SQLite)   │  │   (Files)   │       │     │
│    │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │     │
│    └─────────────────────────────────────────────────────────────────────────────┘     │
│                                           │                                             │
│                                           ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────────────────┐     │
│    │                     Consistency Checker (整合性検証)                         │     │
│    └─────────────────────────────────────────────────────────────────────────────┘     │
│                                           │                                             │
│                                           ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────────────────┐     │
│    │                         Build Agent (統合・ビルド)                           │     │
│    └─────────────────────────────────────────────────────────────────────────────┘     │
│                                           │                                             │
│                                           ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────────────────┐     │
│    │                              Game Output                                     │     │
│    └─────────────────────────────────────────────────────────────────────────────┘     │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 技術スタック

| コンポーネント | 技術 | 理由 |
|--------------|------|------|
| Message Bus | Redis Pub/Sub | シンプル、高速、実績あり |
| Agent実装 | Python asyncio | 非同期処理、並列実行 |
| Data Store | SQLite + ファイルシステム | シンプル、ポータブル |
| LLM | Ollama | ローカル実行、無料 |
| 画像生成 | ComfyUI API | 柔軟、カスタマイズ可能 |
| 音声合成 | VOICEVOX | 高品質日本語、無料 |
| BGM生成 | Suno / MusicGen | 品質とローカルの選択可 |

---

*作成日: 2026-01-14*
*バージョン: 1.0 (マルチエージェント対応)*
