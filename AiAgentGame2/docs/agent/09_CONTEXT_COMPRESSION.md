# コンテキスト圧縮

## 概要

計画が承認された後、探索過程の詳細などの不要なコンテキストを圧縮し、トークン消費を削減する。
圧縮のタイミングと対象を明確にし、必要な情報は保持しながら効率化する。

## 圧縮のタイミング

| タイミング | 圧縮対象 | トリガー |
|-----------|---------|---------|
| 計画承認後 | 探索・調査のコンテキスト | Human承認 |
| Phase完了後 | Phase内の中間成果物詳細 | Phase遷移 |
| イテレーション完了後 | 全体の詳細情報 | イテレーション遷移 |
| コンテキスト上限接近時 | 優先度の低い情報 | 使用率80%超 |

## 圧縮対象と保持対象

### 圧縮対象（削除または要約）

| 対象 | 処理 |
|------|------|
| 探索過程の詳細ログ | 結論のみ保持 |
| 却下された選択肢の詳細 | 理由のみ保持 |
| 試行錯誤の履歴 | 最終的なアプローチのみ保持 |
| 中間生成物 | 最終版のみ保持 |
| 冗長な説明 | 箇条書きに変換 |

### 保持対象（圧縮しない）

| 対象 | 理由 |
|------|------|
| 最終決定事項 | 実装に必要 |
| 重要な制約 | 品質に影響 |
| 依存関係 | タスク実行に必要 |
| Human承認内容 | 証跡として必要 |
| エラー情報 | 再発防止に必要 |

## 圧縮レベル

| レベル | 名称 | 適用条件 | 処理内容 |
|--------|------|---------|---------|
| 1 | 軽量圧縮 | 通常時 | 冗長な部分のみ削除 |
| 2 | 標準圧縮 | 承認後 | 探索過程を要約 |
| 3 | 強力圧縮 | 上限接近時 | 必要最小限のみ保持 |

## 圧縮例

### 圧縮前

長大な調査ログ、比較検討の詳細、却下案の理由など

### 圧縮後

- **決定**: Unity
- **理由**: 開発者経験、豊富なリソース、拡張性
- **却下**: Godot（リソース不足）、Phaser（パフォーマンス懸念）
- **詳細**: sessions/sess_xxx/exploration/engine_selection.md

## 圧縮通知

| 状況 | 通知内容 |
|------|---------|
| コンテキスト80%到達 | 「圧縮を推奨します」 |
| 自動圧縮実行 | 「コンテキストを圧縮しました（XX% → YY%）」 |
| 圧縮後も90%超 | 「追加の圧縮が必要です」 |

## アーカイブ

圧縮された詳細情報はアーカイブに保存。

| パス | 内容 |
|------|------|
| sessions/{session_id}/archives/phase1_exploration.md | Phase1の探索ログ |
| sessions/{session_id}/archives/phase1_decisions.md | Phase1の決定事項 |
| sessions/{session_id}/archives/compression_log.json | 圧縮履歴 |

## 復元

| ケース | 対応 |
|-------|------|
| Human修正指示で過去の検討が必要 | 該当セクションを復元 |
| バグ修正で過去のアプローチを確認 | failed approachesを復元 |
| 全体レビューで経緯確認 | 全体を一時的に復元 |
