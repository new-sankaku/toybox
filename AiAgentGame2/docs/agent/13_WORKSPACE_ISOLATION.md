# 作業領域の重複回避

## 概要

複数のWORKERが同じファイルを編集することによるコンフリクトを防ぐ。
Git Worktreeを活用して各WORKERに独立した作業領域を割り当て、安全に並列作業を行う。

## 問題点

### コンフリクトが発生するケース

WORKER A と WORKER B が同じファイルを同時に編集 → マージ時にコンフリクト → 解決に追加のToken・時間が必要

### コスト比較

| 項目 | コンフリクトなし | コンフリクトあり |
|------|----------------|----------------|
| Token消費 | 1,000 | 3,000+ |
| 時間 | 1分 | 5分+ |
| Human介入 | 不要 | 必要な場合あり |

## 解決策

### 1. Git Worktreeによる分離

| パス | 用途 |
|------|------|
| projects/{project_id}/repo/ | メインリポジトリ |
| projects/{project_id}/worktrees/worker_task_001/ | WORKER Aの作業領域 |
| projects/{project_id}/worktrees/worker_task_002/ | WORKER Bの作業領域 |

### 2. ファイルロック機構

同じファイルを複数WORKERが編集しないよう制御。

## Git Worktree管理

### Worktree操作

| 操作 | 説明 |
|------|------|
| 作成 | タスク開始時にWorktreeを作成、task/{task_id}ブランチを切る |
| マージ | タスク完了後、mainにマージ |
| 削除 | マージ後にWorktreeとブランチを削除 |

### WORKERへのWorktree割り当て

1. WORKER生成時にWorktreeを作成
2. Worktree内で作業
3. 完了時にコミット
4. クリーンアップ（Worktree削除）

## ファイルロック機構

### ロックの種類

| ロック種類 | 説明 | 用途 |
|-----------|------|------|
| 排他ロック | 1つのWORKERのみ | ファイル編集 |
| 共有ロック | 複数WORKER可 | ファイル読み取り |
| ディレクトリロック | ディレクトリ全体 | 大規模な変更 |

### ロック管理

| フィールド | 説明 |
|-----------|------|
| filepath | ロック対象ファイルパス |
| worker_id | ロック所有WORKER ID |
| lock_type | exclusive / shared |
| acquired_at | 取得日時 |
| timeout | タイムアウト |

## 事前コンフリクトチェック

### タスク割り当て時のチェック

1. タスクの変更対象ファイルを取得
2. アクティブなタスクの変更対象ファイルと比較
3. 重複があればコンフリクトの可能性あり → 待機キューへ
4. 重複なければロック取得して割り当て

## マージ戦略

### Integrator LEADERによる統合

1. 完了タスクを依存関係順にソート
2. 順番にマージ実行
3. コンフリクト発生時 → 自動解決を試みる → 不可なら Human にエスカレーション

## 監視メトリクス

| メトリクス | 説明 |
|-----------|------|
| active_worktrees | アクティブなWorktree数 |
| lock_contentions | ロック競合回数 |
| merge_conflicts | マージコンフリクト回数 |
| auto_resolve_rate | 自動解決成功率 |
