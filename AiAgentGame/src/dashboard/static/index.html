<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Game Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* NieR:Automata color palette - beige/sepia */
            --bg-primary: #DAD4BB;
            --bg-secondary: #C8C2AA;
            --bg-tertiary: #B8B29A;
            --border-color: #9A9482;
            --text-primary: #4D493E;
            --text-secondary: #5C5850;
            --text-muted: #7A756A;
            --accent: #4D493E;
            --success: #5A6E4A;
            --error: #8B4D4D;
            --running: #6B6554;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Rajdhani', 'Consolas', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 11px;
            line-height: 1.4;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            height: 32px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 20px;
        }

        .header .title {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .header .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
        }

        .header .status-dot {
            width: 6px;
            height: 6px;
            background: var(--error);
            border-radius: 50%;
        }

        .header .status-dot.connected { background: var(--success); }

        .header .phase-badge {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 2px 8px;
            font-size: 10px;
            letter-spacing: 1px;
        }

        /* Main Layout - 2 column (left + center) */
        .main {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: calc(100vh - 32px);
        }

        /* Left Panel - Control */
        .panel-left {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .panel-section {
            border-bottom: 1px solid var(--border-color);
            padding: 10px;
        }

        .panel-section-title {
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .input-group {
            margin-bottom: 8px;
        }

        .input-group label {
            display: block;
            font-size: 9px;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .input-group input, .input-group select {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 8px;
            font-family: inherit;
            font-size: 11px;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-row {
            display: flex;
            gap: 6px;
        }

        .btn {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 10px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn:hover {
            background: var(--border-color);
        }

        .btn-primary {
            background: var(--text-primary);
            border-color: var(--text-primary);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--text-secondary);
        }

        /* Agent List */
        .agent-list {
            flex: 1;
            overflow-y: auto;
        }

        .agent-item {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.1s;
        }

        .agent-item:hover {
            background: var(--bg-tertiary);
        }

        .agent-item.selected {
            background: var(--bg-tertiary);
            border-left: 2px solid var(--accent);
        }

        .agent-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .agent-name {
            font-size: 11px;
            font-weight: 600;
        }

        .agent-status {
            font-size: 9px;
            padding: 1px 6px;
            border: 1px solid;
        }

        .agent-status.pending { color: var(--text-muted); border-color: var(--text-muted); }
        .agent-status.running { color: var(--running); border-color: var(--running); animation: blink 1s infinite; }
        .agent-status.completed { color: var(--success); border-color: var(--success); }
        .agent-status.error { color: var(--error); border-color: var(--error); }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        .agent-message {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.3;
            word-break: break-word;
            max-height: 40px;
            overflow: hidden;
        }

        .agent-progress-info {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .agent-progress {
            margin-top: 4px;
            height: 3px;
            background: var(--bg-primary);
        }

        .agent-progress-bar {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        /* Agent list scrollbar */
        .agent-list::-webkit-scrollbar {
            width: 6px;
        }
        .agent-list::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .agent-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
        }

        /* Center Panel - Split top/bottom */
        .panel-center {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .panel-center-top {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            border-bottom: 2px solid var(--border-color);
        }

        .panel-center-bottom {
            height: 280px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            resize: vertical;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 8px 16px;
            font-size: 10px;
            letter-spacing: 1px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            flex: 1;
            overflow: hidden;
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Workflow View */
        .workflow-view {
            padding: 15px;
            flex: 1;
            overflow: auto;
        }

        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .workflow-node {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 12px;
            position: relative;
        }

        .workflow-node.running {
            border-color: var(--running);
            box-shadow: 0 0 10px rgba(201, 162, 39, 0.2);
        }

        .workflow-node.completed {
            border-color: var(--success);
        }

        .workflow-node.error {
            border-color: var(--error);
        }

        .workflow-node-name {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .workflow-node-status {
            font-size: 9px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .workflow-node-message {
            font-size: 10px;
            color: var(--text-muted);
        }

        .workflow-node-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--bg-primary);
        }

        .workflow-node-progress-bar {
            height: 100%;
            background: var(--accent);
        }

        /* Log View */
        .log-view {
            flex: 1;
            overflow-y: scroll;
            font-family: 'Consolas', monospace;
            font-size: 10px;
            padding: 8px;
        }

        /* Scrollbar styling */
        .log-view::-webkit-scrollbar {
            width: 8px;
        }
        .log-view::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .log-view::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        .log-view::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid var(--bg-secondary);
            display: grid;
            grid-template-columns: 55px 100px 1fr;
            gap: 6px;
            word-break: break-word;
        }

        .log-time {
            color: var(--text-muted);
            font-size: 9px;
        }

        .log-agent {
            color: var(--accent);
            font-weight: 600;
        }

        .log-message {
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .log-entry.error .log-message { color: var(--error); }
        .log-entry.completed .log-message { color: var(--success); }
        .log-entry.running .log-agent { color: var(--running); }

        /* LLM Config Grid */
        .llm-config-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .llm-config-item {
            background: var(--bg-primary);
            padding: 6px 8px;
            border: 1px solid var(--border-color);
        }

        .llm-config-item .label {
            display: block;
            font-size: 8px;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .llm-config-item .value {
            display: block;
            font-size: 11px;
            color: var(--accent);
            font-weight: 600;
        }

        .detail-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .detail-tab {
            padding: 6px 12px;
            font-size: 9px;
            letter-spacing: 1px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .detail-tab.active {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: none;
        }

        .detail-content.active {
            display: block;
        }

        .detail-section {
            margin-bottom: 12px;
        }

        .detail-section-title {
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 10px;
        }

        .detail-row .label {
            color: var(--text-secondary);
        }

        .detail-row .value {
            color: var(--text-primary);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .stat-box {
            background: var(--bg-primary);
            padding: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
        }

        .stat-label {
            font-size: 9px;
            color: var(--text-muted);
            letter-spacing: 1px;
        }

        /* Agent Detail View */
        .agent-detail-header {
            padding: 10px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .agent-detail-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .agent-detail-status {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .agent-events {
            flex: 1;
            overflow-y: auto;
        }

        .agent-event {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 10px;
        }

        .agent-event-time {
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .agent-event-message {
            color: var(--text-secondary);
        }

        /* Progress indicator */
        .progress-text {
            font-size: 9px;
            color: var(--accent);
        }

        /* Item lists */
        .item-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .item-entry {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 10px;
        }

        .item-entry:hover {
            background: var(--bg-tertiary);
        }

        .item-entry .item-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .item-entry .item-desc {
            color: var(--text-secondary);
        }

        .item-entry .item-meta {
            color: var(--text-muted);
            font-size: 9px;
        }

        .item-entry.error-item {
            border-left: 2px solid var(--error);
        }

        .empty-state {
            color: var(--text-muted);
            padding: 10px;
            text-align: center;
            font-size: 10px;
        }

        /* LLM interactions */
        .llm-list {
            max-height: calc(100vh - 300px);
            overflow-y: scroll;
        }
        .llm-list::-webkit-scrollbar {
            width: 6px;
        }
        .llm-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
        }

        .llm-entry {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-primary);
            margin-bottom: 4px;
        }

        .llm-entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .llm-entry-agent {
            font-weight: 600;
            color: var(--accent);
        }

        .llm-entry-tokens {
            font-size: 9px;
            color: var(--text-muted);
        }

        .llm-entry-params {
            display: flex;
            gap: 12px;
            font-size: 9px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            padding: 3px 6px;
            background: var(--bg-secondary);
            border-radius: 2px;
        }

        .llm-entry-prompt, .llm-entry-response {
            font-size: 9px;
            padding: 6px;
            margin: 4px 0;
            border-radius: 2px;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .llm-entry-prompt {
            background: var(--bg-tertiary);
            border-left: 2px solid var(--text-muted);
        }

        .llm-entry-response {
            background: var(--bg-secondary);
            border-left: 2px solid var(--success);
        }

        .llm-entry-label {
            font-size: 8px;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* Game description */
        .game-description {
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 10px;
            line-height: 1.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">AI Agent Game Creator</div>
        <div class="status">
            <div class="status-dot" id="connection-dot"></div>
            <span id="connection-text">DISCONNECTED</span>
        </div>
        <div class="phase-badge" id="current-phase">IDLE</div>
        <div class="progress-text" id="progress-text"></div>
    </div>

    <div class="main">
        <!-- Left Panel -->
        <div class="panel-left">
            <div class="panel-section">
                <div class="panel-section-title">コントロール</div>
                <div class="input-group">
                    <label>リクエスト</label>
                    <input type="text" id="request-input" value="シンプルなプラットフォーマーゲームを作成">
                </div>
                <div class="input-group">
                    <label>フェーズ</label>
                    <select id="phase-select">
                        <option value="mock">MOCK (最速)</option>
                        <option value="generate">GENERATE (実装)</option>
                        <option value="polish">POLISH (品質)</option>
                        <option value="final">FINAL (本番)</option>
                    </select>
                </div>
                <div class="btn-row">
                    <button class="btn btn-primary" onclick="startWorkflow()">実行</button>
                    <button class="btn" onclick="stopWorkflow()">停止</button>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-section-title">LLM設定</div>
                <div class="input-group">
                    <label>モデル</label>
                    <select id="llm-model-select">
                        <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="gpt-4o">GPT-4o</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                    <div class="input-group">
                        <label>Temperature</label>
                        <input type="number" id="llm-temp-input" value="0.7" min="0" max="2" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Max Tokens</label>
                        <input type="number" id="llm-max-tokens-input" value="4096" min="100" max="32000" step="100">
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-section-title">エージェント</div>
            </div>

            <div class="agent-list" id="agent-list">
                <!-- Agent items will be populated here -->
            </div>
        </div>

        <!-- Center Panel - Split top/bottom -->
        <div class="panel-center">
            <!-- Top: LLM, Tasks, etc tabs -->
            <div class="panel-center-top">
                <div class="detail-tabs">
                    <div class="detail-tab active" data-detail="llm">LLM</div>
                    <div class="detail-tab" data-detail="tasks">タスク</div>
                    <div class="detail-tab" data-detail="errors">エラー</div>
                    <div class="detail-tab" data-detail="assets">アセット</div>
                    <div class="detail-tab" data-detail="review">レビュー</div>
                    <div class="detail-tab" data-detail="stats">統計</div>
                </div>

                <div class="detail-content active" id="detail-llm">
                    <div class="detail-section">
                        <div class="detail-section-title">API設定</div>
                        <div class="llm-config-grid">
                            <div class="llm-config-item">
                                <span class="label">Provider</span>
                                <span class="value" id="llm-provider">anthropic</span>
                            </div>
                            <div class="llm-config-item">
                                <span class="label">Model</span>
                                <span class="value" id="llm-model">claude-sonnet-4-20250514</span>
                            </div>
                            <div class="llm-config-item">
                                <span class="label">Temperature</span>
                                <span class="value" id="llm-temperature">0.7</span>
                            </div>
                            <div class="llm-config-item">
                                <span class="label">Max Tokens</span>
                                <span class="value" id="llm-max-tokens">4096</span>
                            </div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">トークン使用量</div>
                        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="stat-box">
                                <div class="stat-value" id="token-input">0</div>
                                <div class="stat-label">入力</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="token-output">0</div>
                                <div class="stat-label">出力</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="stat-events">0</div>
                                <div class="stat-label">イベント</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="stat-errors">0</div>
                                <div class="stat-label">エラー</div>
                            </div>
                        </div>
                    </div>
                    <div class="detail-section" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <div class="detail-section-title">LLMやり取り履歴 <span id="llm-count">(0)</span></div>
                        <div class="item-list llm-list" id="llm-list" style="flex: 1; overflow-y: auto;">
                            <div class="empty-state">LLMやり取りなし</div>
                        </div>
                    </div>
                </div>

                <div class="detail-content" id="detail-tasks">
                    <div class="detail-section" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="detail-section-title">タスク一覧 <span id="task-count">(0)</span></div>
                        <div class="item-list" id="task-list" style="flex: 1; overflow-y: auto;">
                            <div class="empty-state">タスクなし</div>
                        </div>
                    </div>
                </div>

                <div class="detail-content" id="detail-errors">
                    <div class="detail-section" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="detail-section-title">エラー一覧 <span id="error-count">(0)</span></div>
                        <div class="item-list" id="error-list" style="flex: 1; overflow-y: auto;">
                            <div class="empty-state">エラーなし</div>
                        </div>
                    </div>
                </div>

                <div class="detail-content" id="detail-assets">
                    <div class="detail-section" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="detail-section-title">アセット一覧 <span id="asset-count">(0)</span></div>
                        <div class="item-list" id="asset-list" style="flex: 1; overflow-y: auto;">
                            <div class="empty-state">アセットなし</div>
                        </div>
                    </div>
                </div>

                <div class="detail-content" id="detail-review">
                    <div class="detail-section" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="detail-section-title">レビューコメント <span id="review-count">(0)</span></div>
                        <div class="item-list" id="review-list" style="flex: 1; overflow-y: auto;">
                            <div class="empty-state">コメントなし</div>
                        </div>
                    </div>
                </div>

                <div class="detail-content" id="detail-stats">
                    <div class="detail-section">
                        <div class="detail-section-title">ゲーム仕様</div>
                        <div class="game-description" id="spec-description">-</div>
                        <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
                            <div class="stat-box">
                                <div class="stat-label">タイトル</div>
                                <div class="stat-value" id="spec-title" style="font-size: 12px;">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">ジャンル</div>
                                <div class="stat-value" id="spec-genre" style="font-size: 12px;">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">プラットフォーム</div>
                                <div class="stat-value" id="spec-platform" style="font-size: 12px;">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">ビジュアル</div>
                                <div class="stat-value" id="spec-visual" style="font-size: 12px;">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">オーディオ</div>
                                <div class="stat-value" id="spec-audio" style="font-size: 12px;">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="detail-section-title">統計情報</div>
                        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="stat-box">
                                <div class="stat-value" id="stat-files">0</div>
                                <div class="stat-label">ファイル</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="stat-assets">0</div>
                                <div class="stat-label">アセット</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="stat-started">-</div>
                                <div class="stat-label">開始</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="stat-elapsed">-</div>
                                <div class="stat-label">経過</div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <div class="detail-section-title">生成ファイル</div>
                        <div class="item-list" id="file-list" style="flex: 1; overflow-y: auto;">
                            <div class="empty-state">ファイルなし</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom: Event Log -->
            <div class="panel-center-bottom">
                <div class="tabs">
                    <div class="tab active" data-tab="logs">イベントログ</div>
                </div>
                <div class="tab-content active" id="tab-logs">
                    <div class="log-view" id="log-view">
                        <!-- Log entries will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Agent definitions with workflow order
        const AGENTS = [
            { id: 'planner', name: 'Planner', label: '企画', order: 1 },
            { id: 'coder', name: 'Coder', label: 'コード', order: 2 },
            { id: 'asset_coordinator', name: 'Asset Coordinator', label: 'アセット', order: 3 },
            { id: 'tester', name: 'Tester', label: 'テスト', order: 4 },
            { id: 'debugger', name: 'Debugger', label: 'デバッグ', order: 5 },
            { id: 'reviewer', name: 'Reviewer', label: 'レビュー', order: 6 }
        ];

        const STATUS_LABELS = {
            pending: '待機中',
            running: '実行中',
            completed: '完了',
            error: 'エラー'
        };

        let ws;
        let eventCount = 0;
        let reconnectInterval;
        let selectedAgent = null;
        let agentStates = {};
        let agentEvents = {};
        let startTime = null;
        let elapsedInterval = null;

        // Initialize agent states with detailed info
        AGENTS.forEach(a => {
            agentStates[a.id] = {
                status: 'pending',
                message: '',
                progress: 0,
                details: {},  // Store extra details (counts, lists, etc.)
                result: ''    // Final result summary
            };
            agentEvents[a.id] = [];
        });

        // Format progress info for each agent type
        function getAgentProgressInfo(agentId, state) {
            const d = state.details || {};
            switch(agentId) {
                case 'planner':
                    if (d.task_count) return `タスク: ${d.task_count}件生成`;
                    return '';
                case 'coder':
                    if (d.files) return `ファイル: ${d.files}件 (${d.total_lines || 0}行)`;
                    return '';
                case 'asset_coordinator':
                    if (d.assets) return `アセット: ${d.assets}件 (画像${d.image_count || 0}/音声${d.audio_count || 0})`;
                    return '';
                case 'tester':
                    if (d.files_tested !== undefined) {
                        if (d.test_passed) return `テスト: ${d.files_tested}ファイル全て成功`;
                        return `テスト: ${d.errors}件エラー / ${d.files_tested}ファイル`;
                    }
                    return '';
                case 'debugger':
                    if (d.iteration) return `試行${d.iteration}/10 - ${d.errors_fixed || 0}件修正`;
                    return '';
                case 'reviewer':
                    if (d.comments !== undefined) return `コメント: ${d.comments}件 (重大${d.critical_count || 0}/警告${d.warning_count || 0})`;
                    return '';
                default:
                    return '';
            }
        }

        // Render functions
        function renderAgentList() {
            const container = document.getElementById('agent-list');
            container.innerHTML = AGENTS.map(a => {
                const state = agentStates[a.id];
                const isSelected = selectedAgent === a.id;
                const statusLabel = STATUS_LABELS[state.status] || state.status;
                const progressInfo = getAgentProgressInfo(a.id, state);
                return `
                    <div class="agent-item ${isSelected ? 'selected' : ''}" onclick="selectAgent('${a.id}')">
                        <div class="agent-item-header">
                            <span class="agent-name">${a.label} [${a.name}]</span>
                            <span class="agent-status ${state.status}">${statusLabel}</span>
                        </div>
                        <div class="agent-message">${state.message || '-'}</div>
                        ${progressInfo ? `<div class="agent-progress-info">${progressInfo}</div>` : ''}
                        ${state.status === 'running' ? `
                            <div class="agent-progress">
                                <div class="agent-progress-bar" style="width: ${state.progress}%"></div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderWorkflowGrid() {
            // Removed - using agent list only
        }

        function renderSelectedAgent() {
            if (!selectedAgent) return;

            const agent = AGENTS.find(a => a.id === selectedAgent);
            const state = agentStates[selectedAgent];
            const events = agentEvents[selectedAgent] || [];
            const statusLabel = STATUS_LABELS[state.status] || state.status;

            document.getElementById('selected-agent-header').innerHTML = `
                <div class="agent-detail-name">${agent.label} [${agent.name}]</div>
                <div class="agent-detail-status">${statusLabel} - ${state.message || '待機中...'}</div>
            `;

            document.getElementById('agent-events').innerHTML = events.slice(-20).reverse().map(e => `
                <div class="agent-event">
                    <div class="agent-event-time">${e.timestamp}</div>
                    <div class="agent-event-message">${e.message}</div>
                </div>
            `).join('') || '<div class="agent-event"><div class="agent-event-message">イベントなし</div></div>';
        }

        function addLogEntry(event) {
            const container = document.getElementById('log-view');
            const entry = document.createElement('div');
            entry.className = `log-entry ${event.status}`;
            entry.innerHTML = `
                <span class="log-time">${event.timestamp}</span>
                <span class="log-agent">${event.agent}</span>
                <span class="log-message">${event.message}</span>
            `;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function selectAgent(agentId) {
            selectedAgent = agentId;
            renderAgentList();
            renderSelectedAgent();
        }

        function updateProgress() {
            const completed = AGENTS.filter(a => agentStates[a.id].status === 'completed').length;
            const total = AGENTS.length;
            document.getElementById('progress-text').textContent = `完了: ${completed}/${total}`;
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
            });
        });

        document.querySelectorAll('.detail-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.detail-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`detail-${tab.dataset.detail}`).classList.add('active');
            });
        });

        // WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                document.getElementById('connection-dot').classList.add('connected');
                document.getElementById('connection-text').textContent = 'CONNECTED';
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onclose = () => {
                document.getElementById('connection-dot').classList.remove('connected');
                document.getElementById('connection-text').textContent = 'DISCONNECTED';
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 3000);
                }
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);

                if (msg.type === 'state_update') {
                    updateState(msg.data);
                } else if (msg.type === 'agent_event') {
                    handleAgentEvent(msg.data);
                }
            };
        }

        function updateState(state) {
            document.getElementById('current-phase').textContent = state.phase.toUpperCase();

            for (const [agent, status] of Object.entries(state.agents)) {
                if (agentStates[agent]) {
                    agentStates[agent].status = status;
                }
            }

            if (state.game_spec) {
                document.getElementById('spec-title').textContent = state.game_spec.title || '-';
                document.getElementById('spec-genre').textContent = state.game_spec.genre || '-';
                document.getElementById('spec-platform').textContent = state.game_spec.target_platform || '-';
                document.getElementById('spec-description').textContent = state.game_spec.description || '-';
                document.getElementById('spec-visual').textContent = state.game_spec.visual_style || '-';
                document.getElementById('spec-audio').textContent = state.game_spec.audio_style || '-';
            }

            eventCount = state.events?.length || 0;
            document.getElementById('stat-events').textContent = eventCount;

            state.events?.forEach(e => {
                if (agentEvents[e.agent]) {
                    agentEvents[e.agent].push(e);
                }
            });

            // Update lists
            renderTaskList(state.tasks || []);
            renderErrorList(state.errors || []);
            renderAssetList(state.assets || []);
            renderReviewList(state.review_comments || []);
            renderFileList(state.code_files || []);

            // Update LLM interactions
            if (state.llm_interactions) {
                currentLLMInteractions = state.llm_interactions;
                renderLLMList(currentLLMInteractions);
            }
            if (state.total_tokens) {
                updateTokens(state.total_tokens);
            }

            renderAgentList();
            renderWorkflowGrid();
            renderSelectedAgent();
            updateProgress();
        }

        function renderTaskList(tasks) {
            const container = document.getElementById('task-list');
            document.getElementById('task-count').textContent = `(${tasks.length})`;
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state">タスクなし</div>';
                return;
            }
            container.innerHTML = tasks.map(t => `
                <div class="item-entry">
                    <div class="item-title">${t.id || '-'}</div>
                    <div class="item-desc">${t.description || '-'}</div>
                    <div class="item-meta">${t.assigned_agent || '-'} / ${t.status || '-'}</div>
                </div>
            `).join('');
        }

        function renderErrorList(errors) {
            const container = document.getElementById('error-list');
            document.getElementById('error-count').textContent = `(${errors.length})`;
            document.getElementById('stat-errors').textContent = errors.length;
            if (errors.length === 0) {
                container.innerHTML = '<div class="empty-state">エラーなし</div>';
                return;
            }
            container.innerHTML = errors.map(e => {
                const msg = typeof e === 'string' ? e : (e.message || e.error || JSON.stringify(e));
                return `<div class="item-entry error-item"><div class="item-desc">${msg}</div></div>`;
            }).join('');
        }

        function renderAssetList(assets) {
            const container = document.getElementById('asset-list');
            document.getElementById('asset-count').textContent = `(${assets.length})`;
            document.getElementById('stat-assets').textContent = assets.length;
            if (assets.length === 0) {
                container.innerHTML = '<div class="empty-state">アセットなし</div>';
                return;
            }
            container.innerHTML = assets.map(a => `
                <div class="item-entry">
                    <div class="item-title">${a.name || a}</div>
                    <div class="item-meta">${a.type || '-'}</div>
                </div>
            `).join('');
        }

        function renderReviewList(comments) {
            const container = document.getElementById('review-list');
            document.getElementById('review-count').textContent = `(${comments.length})`;
            if (comments.length === 0) {
                container.innerHTML = '<div class="empty-state">コメントなし</div>';
                return;
            }
            container.innerHTML = comments.map(c => {
                const msg = typeof c === 'string' ? c : (c.message || c.comment || JSON.stringify(c));
                const severity = c.severity || 'info';
                return `<div class="item-entry ${severity === 'error' ? 'error-item' : ''}"><div class="item-desc">${msg}</div></div>`;
            }).join('');
        }

        function renderFileList(files) {
            const container = document.getElementById('file-list');
            document.getElementById('stat-files').textContent = files.length;
            if (files.length === 0) {
                container.innerHTML = '<div class="empty-state">ファイルなし</div>';
                return;
            }
            container.innerHTML = files.map(f => `
                <div class="item-entry"><div class="item-title">${f}</div></div>
            `).join('');
        }

        // Store lists globally for updates
        let currentTasks = [];
        let currentErrors = [];
        let currentAssets = [];
        let currentReviews = [];
        let currentFiles = [];
        let currentLLMInteractions = [];
        let totalTokens = { input: 0, output: 0 };

        // Render LLM interaction list
        function renderLLMList(interactions) {
            const container = document.getElementById('llm-list');
            document.getElementById('llm-count').textContent = `(${interactions.length})`;
            if (interactions.length === 0) {
                container.innerHTML = '<div class="empty-state">LLMやり取りなし</div>';
                return;
            }
            container.innerHTML = interactions.slice().reverse().map(i => `
                <div class="llm-entry">
                    <div class="llm-entry-header">
                        <span class="llm-entry-agent">${i.agent}</span>
                        <span class="llm-entry-tokens">入力: ${i.input_tokens} / 出力: ${i.output_tokens}</span>
                    </div>
                    <div class="llm-entry-params">
                        <span>Model: ${i.model || '-'}</span>
                        <span>Temp: ${i.temperature !== undefined ? i.temperature : '-'}</span>
                        <span>MaxTok: ${i.max_tokens || '-'}</span>
                    </div>
                    <div class="llm-entry-label">プロンプト</div>
                    <div class="llm-entry-prompt">${escapeHtml(i.prompt || '')}</div>
                    <div class="llm-entry-label">応答</div>
                    <div class="llm-entry-response">${escapeHtml(i.response || '')}</div>
                </div>
            `).join('');
        }

        // Escape HTML for safe display
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update token display
        function updateTokens(tokens) {
            if (tokens) {
                totalTokens = tokens;
                document.getElementById('token-input').textContent = tokens.input || 0;
                document.getElementById('token-output').textContent = tokens.output || 0;
            }
        }

        // Update game spec display
        function updateGameSpec(spec) {
            if (!spec) return;
            document.getElementById('spec-title').textContent = spec.title || '-';
            document.getElementById('spec-genre').textContent = spec.genre || '-';
            document.getElementById('spec-platform').textContent = spec.target_platform || '-';
            document.getElementById('spec-visual').textContent = spec.visual_style || '-';
            document.getElementById('spec-audio').textContent = spec.audio_style || '-';
            document.getElementById('spec-description').textContent = spec.description || '-';
        }

        function handleAgentEvent(event) {
            eventCount++;
            document.getElementById('stat-events').textContent = eventCount;

            if (agentStates[event.agent]) {
                agentStates[event.agent].status = event.status;
                agentStates[event.agent].message = event.message;

                // Store event details for progress display
                if (event.details) {
                    agentStates[event.agent].details = {
                        ...agentStates[event.agent].details,
                        ...event.details
                    };
                }

                // Estimate progress based on status
                if (event.status === 'running') {
                    agentStates[event.agent].progress = 50;
                } else if (event.status === 'completed') {
                    agentStates[event.agent].progress = 100;
                }
            }

            if (!agentEvents[event.agent]) {
                agentEvents[event.agent] = [];
            }
            agentEvents[event.agent].push(event);

            // Update lists from event details (real-time)
            if (event.details) {
                if (event.details.task_list !== undefined) {
                    currentTasks = event.details.task_list;
                    renderTaskList(currentTasks);
                }
                if (event.details.error_list !== undefined) {
                    currentErrors = event.details.error_list;
                    renderErrorList(currentErrors);
                }
                if (event.details.asset_list !== undefined) {
                    currentAssets = event.details.asset_list;
                    renderAssetList(currentAssets);
                }
                if (event.details.comment_list !== undefined) {
                    currentReviews = event.details.comment_list;
                    renderReviewList(currentReviews);
                }
                if (event.details.file_list !== undefined) {
                    currentFiles = event.details.file_list;
                    renderFileList(currentFiles);
                }
                // Also update spec if available (full game_spec or individual fields)
                if (event.details.game_spec) {
                    updateGameSpec(event.details.game_spec);
                }
                if (event.details.title) {
                    document.getElementById('spec-title').textContent = event.details.title;
                }
                if (event.details.genre) {
                    document.getElementById('spec-genre').textContent = event.details.genre;
                }
                if (event.details.target_platform) {
                    document.getElementById('spec-platform').textContent = event.details.target_platform;
                }
                if (event.details.visual_style) {
                    document.getElementById('spec-visual').textContent = event.details.visual_style;
                }
                if (event.details.audio_style) {
                    document.getElementById('spec-audio').textContent = event.details.audio_style;
                }
                if (event.details.description) {
                    document.getElementById('spec-description').textContent = event.details.description;
                }
                // Handle LLM interactions
                if (event.details.llm_interaction) {
                    currentLLMInteractions.push(event.details.llm_interaction);
                    renderLLMList(currentLLMInteractions);
                }
                if (event.details.total_tokens) {
                    updateTokens(event.details.total_tokens);
                }
            }

            addLogEntry(event);
            renderAgentList();
            renderWorkflowGrid();
            if (selectedAgent === event.agent) {
                renderSelectedAgent();
            }
            updateProgress();
        }

        async function startWorkflow() {
            const request = document.getElementById('request-input').value;
            const phase = document.getElementById('phase-select').value;
            const model = document.getElementById('llm-model-select').value;
            const temperature = parseFloat(document.getElementById('llm-temp-input').value);
            const maxTokens = parseInt(document.getElementById('llm-max-tokens-input').value);

            // Update LLM config display
            document.getElementById('llm-model').textContent = model;
            document.getElementById('llm-temperature').textContent = temperature;
            document.getElementById('llm-max-tokens').textContent = maxTokens;

            // Reset state with new structure
            AGENTS.forEach(a => {
                agentStates[a.id] = {
                    status: 'pending',
                    message: '',
                    progress: 0,
                    details: {},
                    result: ''
                };
                agentEvents[a.id] = [];
            });
            eventCount = 0;

            // Reset all lists
            currentTasks = [];
            currentErrors = [];
            currentAssets = [];
            currentReviews = [];
            currentFiles = [];
            renderTaskList([]);
            renderErrorList([]);
            renderAssetList([]);
            renderReviewList([]);
            renderFileList([]);

            // Reset spec display
            document.getElementById('spec-title').textContent = '-';
            document.getElementById('spec-genre').textContent = '-';
            document.getElementById('spec-platform').textContent = '-';
            document.getElementById('spec-visual').textContent = '-';
            document.getElementById('spec-audio').textContent = '-';
            document.getElementById('spec-description').textContent = '-';

            // Reset LLM interactions
            currentLLMInteractions = [];
            totalTokens = { input: 0, output: 0 };
            renderLLMList([]);
            updateTokens({ input: 0, output: 0 });

            // Reset stats
            document.getElementById('log-view').innerHTML = '';
            document.getElementById('stat-events').textContent = '0';
            document.getElementById('stat-files').textContent = '0';
            document.getElementById('stat-assets').textContent = '0';
            document.getElementById('stat-errors').textContent = '0';

            startTime = new Date();
            document.getElementById('stat-started').textContent = startTime.toLocaleTimeString();

            if (elapsedInterval) clearInterval(elapsedInterval);
            elapsedInterval = setInterval(() => {
                const elapsed = Math.floor((new Date() - startTime) / 1000);
                const min = Math.floor(elapsed / 60);
                const sec = elapsed % 60;
                document.getElementById('stat-elapsed').textContent = `${min}:${sec.toString().padStart(2, '0')}`;
            }, 1000);

            renderAgentList();
            renderWorkflowGrid();

            try {
                await fetch('/api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        request,
                        phase,
                        llm_config: {
                            model: model,
                            temperature: temperature,
                            max_tokens: maxTokens
                        }
                    })
                });
            } catch (error) {
                console.error('Failed to start:', error);
            }
        }

        async function stopWorkflow() {
            if (elapsedInterval) {
                clearInterval(elapsedInterval);
                elapsedInterval = null;
            }
            try {
                await fetch('/api/stop', { method: 'POST' });
            } catch (error) {
                console.error('Failed to stop:', error);
            }
        }

        // Initialize
        connectWebSocket();
        renderAgentList();
        renderWorkflowGrid();
    </script>
</body>
</html>
